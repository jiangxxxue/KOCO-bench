import unittest
import torch
import sys
import os
import torch.nn.functional as F

# Add the src directory to Python path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

# Import the actual function we want to test
from open_r1.coupled_grpo import selective_log_softmax


class TestSelectiveLogSoftmax(unittest.TestCase):
    """Test selective_log_softmax function - Efficiently calculate weighted log probabilities"""
    
    def setUp(self):
        torch.manual_seed(42)
        self.vocab_size = 10
    
    def test_selective_log_softmax_basic_output_shape(self):
        """Test basic output shape"""
        num_iterations = 2
        batch_size = 3
        seq_len = 10
        
        # Create input data
        logits = torch.tensor([[[ 1.9269e+00,  1.4873e+00,  9.0072e-01, -2.1055e+00,  6.7842e-01, -1.2345e+00, -4.3067e-02, -1.6047e+00, -7.5214e-01,  1.6487e+00],
         [-3.9248e-01, -1.4036e+00, -7.2788e-01, -5.5943e-01, -7.6884e-01,  7.6245e-01,  1.6423e+00, -1.5960e-01, -4.9740e-01,  4.3959e-01],
         [-7.5813e-01,  1.0783e+00,  8.0080e-01,  1.6806e+00,  1.2791e+00,  1.2964e+00,  6.1047e-01,  1.3347e+00, -2.3162e-01,  4.1759e-02],
         [-2.5158e-01,  8.5986e-01, -1.3847e+00, -8.7124e-01, -2.2337e-01,  1.7174e+00,  3.1888e-01, -4.2452e-01,  3.0572e-01, -7.7459e-01],
         [-1.5576e+00,  9.9564e-01, -8.7979e-01, -6.0114e-01, -1.2742e+00,  2.1228e+00, -1.2347e+00, -4.8791e-01, -9.1382e-01, -6.5814e-01],
         [ 7.8024e-02,  5.2581e-01, -4.8799e-01,  1.1914e+00, -8.1401e-01, -7.3599e-01, -1.4032e+00,  3.6004e-02, -6.3477e-02,  6.7561e-01],
         [-9.7807e-02,  1.8446e+00, -1.1845e+00,  1.3835e+00,  1.4451e+00,  8.5641e-01,  2.2181e+00,  5.2317e-01,  3.4665e-01, -1.9733e-01],
         [-1.0546e+00,  1.2780e+00, -1.7219e-01,  5.2379e-01,  5.6622e-02,  4.2630e-01,  5.7501e-01, -6.4172e-01, -2.2064e+00, -7.5080e-01],
         [ 1.0868e-02, -3.3874e-01, -1.3407e+00, -5.8537e-01,  5.3619e-01,  5.2462e-01,  1.1412e+00,  5.1644e-02,  7.4395e-01, -4.8158e-01],
         [-1.0495e+00,  6.0390e-01, -1.7223e+00, -8.2777e-01,  1.3347e+00,  4.8354e-01, -2.5095e+00,  4.8800e-01,  7.8459e-01,  2.8647e-02]],

        [[ 6.4076e-01,  5.8325e-01,  1.0669e+00, -4.5015e-01, -1.8527e-01,  7.5276e-01,  4.0476e-01,  1.7847e-01,  2.6491e-01,  1.2732e+00],
         [-1.3109e-03, -3.0360e-01, -1.4570e+00, -1.0234e-01, -5.9915e-01,  4.7706e-01,  7.2618e-01,  9.1152e-02, -3.8907e-01,  5.2792e-01],
         [-1.2685e-02,  2.4084e-01,  1.3254e-01,  7.6424e-01,  1.0950e+00,  3.3989e-01,  7.1997e-01,  4.1141e-01,  1.9312e+00,  1.0119e+00],
         [-1.4364e+00, -1.1299e+00, -1.3603e-01,  1.6354e+00,  6.5474e-01,  5.7600e-01,  1.1415e+00,  1.8565e-02, -1.8058e+00,  9.2543e-01],
         [-3.7534e-01,  1.0331e+00, -6.8665e-01,  6.3681e-01, -9.7267e-01,  9.5846e-01,  1.6192e+00,  1.4506e+00,  2.6948e-01, -2.1038e-01],
         [-7.3280e-01,  1.0430e-01,  3.4875e-01,  9.6759e-01, -4.6569e-01,  1.6048e+00, -2.4801e+00, -4.1754e-01, -1.1955e+00,  8.1234e-01],
         [-1.9006e+00,  2.2858e-01,  2.4859e-02, -3.4595e-01,  2.8683e-01, -7.3084e-01,  1.7482e-01, -1.0939e+00, -1.6022e+00,  1.3529e+00],
         [ 1.2888e+00,  5.2295e-02, -1.5469e+00,  7.5671e-01,  7.7552e-01,  2.0265e+00,  3.5818e-02,  1.2059e-01, -8.0566e-01, -2.0758e-01],
         [-9.3195e-01, -1.5910e+00, -1.1360e+00, -5.2260e-01, -5.1877e-01, -1.5013e+00, -1.9267e+00,  1.2785e-01,  1.0229e+00, -5.5580e-01],
         [ 7.0427e-01,  7.0988e-01,  1.7744e+00, -9.2155e-01,  9.6245e-01, -3.3702e-01, -1.1753e+00,  3.5806e-01,  4.7877e-01,  1.3537e+00]],

        [[ 5.2606e-01,  2.1120e+00, -5.2076e-01, -9.3201e-01,  1.8516e-01,  1.0687e+00,  1.3065e+00,  4.5983e-01, -8.1463e-01, -1.0212e+00],
         [-4.9492e-01, -5.9225e-01,  1.5432e-01,  4.4077e-01, -1.4829e-01, -2.3184e+00, -3.9800e-01,  1.0805e+00, -1.7809e+00,  1.5080e+00],
         [ 3.0943e-01, -5.0031e-01,  1.0350e+00,  1.6896e+00, -4.5051e-03,  1.6668e+00,  1.5392e-01, -1.0603e+00, -5.7266e-01,  8.3568e-02],
         [ 3.9991e-01,  1.9892e+00, -7.1988e-02, -9.0609e-01, -2.0487e+00, -1.0811e+00,  1.7623e-02,  7.8226e-02,  1.9316e-01,  4.0967e-01],
         [-9.2913e-01,  2.7619e-01, -5.3888e-01,  4.6258e-01, -8.7189e-01, -2.7118e-02, -3.5325e-01,  1.4639e+00,  1.2554e+00, -7.1496e-01],
         [ 8.5392e-01,  5.1299e-01,  5.3973e-01,  5.6551e-01,  5.0579e-01,  2.2245e-01, -6.8548e-01,  5.6356e-01, -1.5072e+00, -1.6107e+00],
         [-1.4790e+00,  4.3227e-01, -1.2503e-01,  7.8212e-01, -1.5988e+00, -1.0913e-01,  7.1520e-01,  3.9139e-02,  1.3059e+00,  2.4659e-01],
         [-1.9776e+00,  1.7896e-02, -1.3793e+00,  6.2580e-01, -2.5850e+00, -2.4000e-02, -1.2219e-01, -7.4700e-01,  1.7093e+00,  5.7923e-02],
         [ 1.1930e+00,  1.9373e+00,  7.2871e-01,  9.8089e-01,  4.1459e-01,  1.1566e+00,  2.6905e-01, -3.6629e-02,  9.7329e-01, -1.0151e+00],
         [-5.4192e-01, -4.4102e-01, -3.1362e-01, -1.2925e-01, -7.1496e-01, -4.7562e-02,  2.0207e+00,  2.5392e-01,  9.3644e-01,  7.1224e-01]],

        [[-3.1766e-02,  1.0164e-01,  1.3433e+00,  7.1327e-01,  4.0380e-01, -7.1398e-01,  8.3373e-01, -9.5855e-01,  4.5363e-01,  1.2461e+00],
         [-2.3065e+00, -1.2869e+00,  1.7989e-01, -2.1268e+00, -1.3408e-01, -1.0408e+00, -7.6472e-01, -5.5283e-02,  1.2049e+00, -9.8247e-01],
         [ 4.3344e-01, -7.1719e-01,  1.0554e+00, -1.4534e+00,  4.6515e-01,  3.7139e-01, -4.6568e-03,  7.9549e-02,  3.7818e-01,  7.0511e-01],
         [-1.7237e+00, -8.4348e-01,  4.3514e-01,  2.6589e-01, -5.8710e-01,  8.2689e-02,  8.8538e-01,  1.8244e-01,  7.8638e-01, -5.7920e-02],
         [ 5.6667e-01, -7.0976e-01, -4.8751e-01,  5.0096e-02,  6.0841e-01,  1.6309e+00, -8.4723e-02,  1.0844e+00,  9.4777e-01, -6.7663e-01],
         [-5.7302e-01, -3.3032e-01, -7.9394e-01,  3.7523e-01,  8.7910e-02, -1.2415e+00, -3.2025e-01, -8.4438e-01, -5.5135e-01,  1.9890e+00],
         [ 1.9003e+00,  1.6951e+00,  2.8090e-02, -1.7537e-01, -1.7735e+00, -7.0464e-01, -3.9465e-01,  1.8868e+00, -2.1844e-01,  1.6630e-01],
         [ 2.1442e+00,  1.7046e+00,  3.4590e-01,  6.4248e-01, -2.0395e-01,  6.8537e-01, -1.3969e-01, -1.1808e+00, -1.2829e+00,  4.4849e-01],
         [-5.9074e-01,  8.5406e-01, -4.9007e-01, -3.5946e-01,  6.6637e-01, -7.4265e-02, -2.0960e-01,  1.6632e-01,  1.4703e+00, -9.3909e-01],
         [-6.0132e-01, -9.9640e-02, -9.8515e-01, -2.4885e+00, -3.3132e-01,  8.4358e-01,  9.8745e-01, -3.3197e-01, -8.0762e-01,  8.2436e-01]],

        [[ 2.4700e-02, -1.0641e+00, -7.6019e-01, -4.0751e-01,  9.6236e-01, -1.4264e-01,  1.5271e-01, -3.8802e-02,  9.4461e-01, -1.5824e+00],
         [ 9.8713e-01,  1.1457e+00, -1.4181e-01, -2.7634e-01, -1.9321e-01,  7.7678e-01,  6.8388e-01, -1.3246e+00, -5.1608e-01,  6.0018e-01],
         [-4.7022e-01, -6.0864e-01, -4.6192e-02, -1.6457e+00, -4.8333e-01, -7.4029e-01,  3.1428e-01,  1.4156e-01,  1.0348e+00, -6.2644e-01],
         [-5.1509e-01,  6.9029e-01, -4.9400e-01,  1.1366e+00, -4.6184e-01,  1.4200e+00,  8.4852e-01, -4.7891e-02,  6.6856e-01,  1.0430e+00],
         [ 6.8990e-01, -1.3129e+00,  3.7804e-02, -1.1702e+00, -1.0319e-01,  1.1895e+00,  7.6069e-01, -7.4630e-01, -1.3839e+00,  4.8687e-01],
         [-1.0020e+00,  3.2949e-02, -4.2920e-01, -9.8180e-01, -6.4206e-01,  8.2659e-01,  1.5914e+00, -1.2081e-01, -4.8302e-01,  1.1330e-01],
         [ 7.7151e-02, -9.2281e-01, -1.2620e+00,  1.0861e+00,  1.0966e+00, -6.8369e-01,  6.6043e-02, -7.7380e-04,  1.6206e-01,  1.1960e+00],
         [-1.3062e+00, -1.4040e+00, -1.0597e+00,  3.0573e-01,  4.1506e-01, -7.1741e-01,  2.8340e+00,  1.9535e+00,  2.0487e+00, -1.0880e+00],
         [ 1.6217e+00,  8.5127e-01, -4.0047e-01, -6.0883e-01, -5.0810e-01, -6.1849e-01, -1.6470e+00, -1.0362e+00, -4.5031e-01, -7.2966e-02],
         [-5.4795e-01, -1.1426e+00, -4.4875e-01, -3.0454e-02,  3.8303e-01, -4.4770e-02,  1.1799e+00, -3.3143e-01,  6.4950e-01,  9.4959e-02]],

        [[-7.5259e-01, -6.4723e-01, -1.2823e+00,  1.9653e+00, -9.6385e-01, -2.5668e+00,  7.0961e-01,  8.1984e-01,  6.2145e-01,  4.2319e-01],
         [-3.3890e-01,  5.1797e-01, -1.3638e+00,  1.9296e-01, -6.1033e-01,  1.6323e-01,  1.5102e+00,  2.1230e-01, -7.2520e-01, -9.5277e-01],
         [ 5.2169e-01, -4.6387e-01,  1.8238e-01, -3.8666e-01, -1.7907e+00,  9.3293e-02, -1.9153e+00, -6.4218e-01,  1.3439e+00, -1.2922e+00],
         [ 7.6624e-01,  6.4540e-01,  3.5332e-01, -2.6475e+00, -1.4575e+00, -9.7124e-01,  2.5403e-01, -1.7906e-01,  1.1993e+00, -4.2922e-01],
         [ 1.0103e+00,  6.1104e-01,  1.2208e+00, -6.0764e-01, -1.7376e+00, -1.2535e-01, -1.3658e+00,  1.1117e+00, -6.2280e-01, -7.8918e-01],
         [-1.6782e-01,  1.6433e+00,  2.0071e+00, -1.2531e+00,  1.1189e+00,  1.7733e+00, -2.0717e+00, -4.1253e-01, -9.7696e-01, -3.3634e-02],
         [ 1.8595e+00,  2.6221e+00,  3.6905e-01,  3.8030e-01,  1.9898e-01, -2.3609e-01,  3.0341e-01, -4.5008e-01,  4.7390e-01,  6.5034e-01],
         [ 1.1662e+00,  1.6936e-02,  5.3259e-01, -6.0354e-01, -1.7426e-01,  6.0921e-01, -8.0322e-01, -1.1209e+00,  1.9564e-01, -7.8152e-01],
         [-1.7899e+00, -2.6157e-01, -4.4025e-01,  2.1848e+00, -4.8010e-01, -1.2872e+00,  7.3888e-01,  3.3895e-02, -3.1229e-01, -2.5418e-01],
         [-1.2055e+00, -9.5421e-01,  6.1277e-02,  8.5261e-02,  7.4813e-01, -1.6356e-01, -9.0856e-01,  3.1300e-01,  8.0505e-01, -1.1134e+00]],

        [[ 4.9816e-01, -1.2000e+00,  1.2711e-01,  4.4037e-01,  6.3777e-01,  1.5979e-01,  1.7698e+00,  6.2682e-01, -1.8737e+00,  2.3259e+00],
         [-9.2039e-01,  6.6611e-01, -4.4026e-01, -2.3180e+00,  1.2946e+00,  2.2267e-01, -8.4834e-01,  1.6489e+00,  1.6006e+00, -7.8589e-02],
         [ 4.3105e-01,  3.6835e-01,  7.6380e-01,  1.1792e+00, -4.1379e-01,  5.1841e-01, -7.0154e-01, -4.3234e-01,  1.4148e-01,  7.1104e-02],
         [ 5.6335e-01, -5.7864e-01, -1.0838e+00, -3.8893e-01,  8.1261e-01,  1.4981e+00,  4.3896e-02,  1.4443e+00,  2.3203e-01,  5.0650e-01],
         [-1.2787e+00, -3.8427e-02,  1.9138e+00,  3.3784e-01,  1.2506e-01, -7.6215e-01, -1.1906e+00,  7.7561e-01,  4.5572e-01,  2.5033e-01],
         [-1.3611e+00,  1.8018e+00, -7.4342e-02, -1.5664e-01, -8.7085e-01, -6.4110e-01, -4.1456e-01, -6.9024e-01, -2.2996e-01, -2.1723e+00],
         [ 8.7683e-02,  1.0938e+00, -1.1772e-01, -2.9864e-01, -9.5362e-01, -9.2473e-02, -1.0167e+00, -7.6757e-03, -5.1822e-01,  8.3954e-01],
         [ 5.8523e-02, -1.6682e+00,  2.1296e+00, -1.5181e+00,  1.3873e-01, -1.1798e+00, -5.2974e-01,  9.6252e-01,  2.7944e-01, -5.7182e-01],
         [-2.7936e+00, -7.1115e-01,  5.2352e-01, -1.7106e+00,  8.3849e-01, -2.6985e-01,  1.2306e-01,  8.7575e-01,  1.5133e-01,  7.3939e-01],
         [ 2.7310e-01,  2.7312e+00,  4.3201e-01, -3.0918e-01, -9.6581e-02,  1.5419e+00, -1.0874e-01, -4.1890e-01,  1.4384e+00, -7.0684e-01]],

        [[-1.2520e+00,  3.0250e+00,  1.3463e+00,  8.5561e-01,  3.2203e-01,  4.4606e-01,  1.5230e+00,  1.2805e+00, -1.1616e-01,  1.3705e+00],
         [-4.8094e-01, -9.9036e-01, -1.3642e+00,  8.2057e-03, -4.0586e-01, -7.1109e-01, -3.4958e-01,  3.7975e-01,  9.9930e-01,  1.2752e+00],
         [ 9.5949e-01,  1.0351e-01,  8.2903e-01,  2.0921e+00,  7.9531e-01,  2.7928e-01,  1.8645e-01,  3.5471e-01,  9.0639e-02,  1.7423e+00],
         [-1.2660e+00,  3.8916e-01,  3.4288e-01, -1.4591e+00, -1.4937e+00, -2.2139e-01,  2.2524e-01, -7.7245e-02,  9.8569e-01,  1.2783e+00],
         [ 2.8815e-01,  8.6905e-01, -8.0971e-01, -1.4299e+00,  4.5902e-01,  5.3093e-01, -1.3615e+00,  1.9562e+00,  1.7685e+00, -9.8580e-01],
         [-1.2371e+00, -2.3019e+00, -1.0087e-03, -8.4943e-01, -1.6594e+00,  3.0629e-01,  1.1820e+00,  3.2603e-01, -3.8945e-01,  2.8544e+00],
         [ 8.2437e-01,  7.9835e-01,  1.8890e+00,  5.9346e-01,  6.9654e-02, -1.6034e+00, -4.2982e-01,  5.7616e-01,  3.4436e-01, -3.1016e+00],
         [-1.4587e+00, -1.4318e+00, -6.0713e-01, -2.5974e-01, -7.1902e-01, -3.8583e-01,  5.2335e-01, -8.2118e-01, -4.7087e-01,  6.0164e-01],
         [-2.8251e-01,  7.6927e-01, -7.6689e-01, -9.4949e-01,  1.6917e-02,  8.0277e-02,  7.4484e-01,  1.3455e+00,  1.2682e-01, -2.4521e+00],
         [ 4.1598e-01,  1.9025e+00, -7.3467e-01,  4.4657e-02, -1.5211e+00,  3.4784e-01,  7.4018e-01,  1.4162e+00,  6.8340e-01, -1.3825e-01]],

        [[ 9.2130e-01,  5.2824e-01, -8.2284e-03, -1.4493e+00, -6.0518e-01, -1.7925e-01,  1.9956e-01, -1.2462e+00, -4.1460e-01,  1.4559e+00],
         [ 3.3165e-01, -1.0001e+00, -6.9195e-01, -4.7199e-01, -1.2894e+00,  1.0763e+00, -1.0667e+00, -1.9893e+00,  2.9731e-01,  4.3446e-01],
         [ 3.3933e-03, -1.0240e+00,  2.2405e-01, -7.5548e-01,  1.3676e+00, -3.1974e-01, -9.1309e-01,  1.9192e+00, -1.6515e+00,  2.1477e+00],
         [-6.6041e-01,  1.1353e-01, -2.2057e-01,  7.1181e-01,  3.4159e-01,  1.5886e+00, -3.4888e-01, -4.5792e-01, -1.2322e+00, -5.9808e-01],
         [-2.8155e-01,  5.2819e-02,  4.2498e-01,  4.8258e-01,  4.8813e-01,  1.0082e+00, -5.9500e-01,  3.9263e-01,  8.2297e-01, -8.8603e-01],
         [ 1.4801e+00,  8.3915e-01, -2.0005e-01,  9.9495e-01,  7.2019e-01, -1.3413e-01, -1.4068e+00, -2.3610e+00, -2.9049e-01, -1.3346e-01],
         [-1.5693e-01,  1.1383e+00, -2.5052e-01,  1.6705e+00, -5.4527e-01, -2.1582e+00, -1.6608e+00, -6.6374e-01,  3.6579e-01, -3.9920e-01],
         [ 4.9674e-01, -2.3692e+00, -5.6147e-01, -5.9491e-01,  1.2687e+00,  1.2904e+00, -1.1756e+00, -7.8323e-02, -9.7058e-01,  1.4724e+00],
         [ 1.4109e+00, -1.3144e+00, -1.3162e+00, -1.2524e+00, -1.5844e+00, -2.5447e+00,  1.3719e+00, -5.3795e-01,  7.3784e-01, -8.5053e-01],
         [ 3.6101e-02,  1.3407e+00,  9.2000e-01, -3.7876e-01, -1.5598e+00, -8.0095e-01, -7.1111e-01, -3.8667e-01,  9.5783e-01, -8.2253e-01]],

        [[-2.3908e+00,  3.2225e-01,  1.8754e+00,  1.1043e+00, -5.2238e-01, -7.4018e-01,  1.6236e-01, -2.3700e-01,  5.0993e-01,  1.6706e+00],
         [ 1.5921e+00, -4.1619e-01,  1.8619e+00, -1.0779e+00,  8.8486e-01, -8.3421e-01,  1.0301e+00, -8.6810e-01, -5.7016e-01,  3.2332e-01],
         [ 1.1285e+00, -1.2123e+00,  2.6024e+00, -9.5724e-02, -8.1148e-02,  1.2587e+00,  8.6913e-01, -9.6094e-01,  5.1823e-02, -3.2848e-01],
         [-2.2472e+00, -4.4790e-01,  4.2347e-01, -3.8746e-01, -2.2964e-01, -4.0709e-01,  8.7030e-01, -1.0553e+00, -1.3284e+00,  7.0607e-01],
         [ 3.5730e-01,  5.8928e-01,  9.1878e-01,  6.6628e-01,  2.4651e-01,  1.3287e-01,  1.2191e-01,  4.7809e-01,  2.7613e-01, -5.8957e-01],
         [ 5.6918e-01, -7.9111e-01, -1.9897e-01, -1.3616e+00, -5.1936e-01,  7.6482e-02,  3.4005e-01,  1.4557e+00, -3.4610e-01, -2.6338e-01],
         [-4.4770e-01, -7.2882e-01, -1.6066e-01, -3.2064e-01, -6.3077e-01, -7.8877e-01,  1.3062e+00, -9.2758e-01, -2.6274e-01,  9.3150e-01],
         [-4.5935e-01, -9.4195e-01, -7.0892e-01,  2.1861e+00, -6.4932e-01,  4.5214e-01,  8.5207e-01, -1.6947e+00,  1.1806e+00, -2.8929e+00],
         [-3.8758e-01, -7.1240e-01, -1.6171e+00, -3.5899e-01,  5.1367e-02,  6.9502e-01,  1.8352e+00, -1.9180e+00, -1.3924e+00,  5.4047e-01],
         [ 4.3507e-01, -2.2717e+00, -1.3386e-01, -5.8557e-02,  1.2574e-01, -5.5258e-01,  7.4480e-02, -1.4929e-01, -5.5225e-01, -9.3420e-02]],

        [[-1.0284e+00,  4.0444e-01,  2.1426e+00, -5.1537e-01,  1.0827e+00,  1.2499e+00,  9.8214e-01,  2.2690e-01,  4.9279e-01, -5.1283e-01],
         [ 3.0062e-01,  7.7347e-02,  6.4777e-01, -4.3242e-01,  1.1740e+00,  7.0114e-01,  6.6743e-01, -8.0360e-01, -1.3776e+00, -4.4105e-01],
         [ 1.4176e-01,  1.1085e+00,  5.5442e-01,  1.5818e+00, -1.2248e+00,  9.6289e-01, -1.5785e+00,  6.7160e-01, -6.0152e-02,  6.9784e-02],
         [-1.6635e+00, -7.6506e-01,  1.2306e+00,  4.2521e-01, -1.6383e-02, -1.0749e-01, -1.3086e+00,  6.5981e-01, -7.0325e-02,  2.7448e-01],
         [-3.4501e-01, -1.1962e-01,  1.1862e+00, -1.2203e+00,  2.9100e-01, -7.9642e-02,  1.3200e+00, -1.5197e+00, -2.9336e-01,  2.1066e+00],
         [-1.0875e-01,  6.0834e-01,  7.8943e-01,  7.8247e-01, -6.4659e-02, -2.3021e-04,  6.8309e-01,  1.0637e-01,  3.5032e-01,  1.2110e-01],
         [ 2.9843e-01,  1.3448e+00,  1.4614e+00,  1.0566e+00,  8.1554e-01, -8.2406e-01,  8.9328e-01, -3.8688e-01, -3.5718e-01, -1.1568e+00],
         [-1.7660e+00, -2.5380e+00,  9.6943e-02, -7.9121e-01,  3.7120e-01,  1.5118e+00, -8.9146e-01,  5.2475e-01,  3.5178e-01,  2.4913e-01],
         [ 1.1900e+00,  1.4109e+00,  7.9801e-01,  4.9413e-01, -1.8495e-01, -1.0381e+00, -1.0130e-01, -9.2718e-01,  2.3484e-01,  8.8615e-02],
         [-3.4769e-01,  8.4907e-01,  2.0147e-01,  3.8398e-01,  1.2310e+00,  1.2287e+00,  7.0421e-01, -5.6285e-02, -1.4897e+00, -1.5195e+00]],

        [[ 3.2581e-01, -1.4584e+00,  1.8989e+00, -4.0566e-02, -2.9337e-01,  1.3978e+00, -9.1666e-01, -7.7937e-01, -4.1754e-01,  1.1060e+00],
         [ 2.5285e-01, -1.0754e-01,  7.7053e-01, -1.1304e+00,  9.9646e-01, -1.1810e+00,  9.6260e-01, -1.1049e+00, -7.9095e-01, -2.1609e-01],
         [ 1.9485e-03, -2.0979e-01,  1.2010e+00,  6.7560e-01, -1.8900e+00,  1.9432e-01,  1.6020e+00, -1.0372e+00, -7.4869e-01, -3.8440e-01],
         [ 1.4350e-01, -8.1268e-02,  1.1262e+00,  4.0618e-02, -6.4642e-02,  3.4456e+00, -1.1129e+00, -4.3420e-01, -1.5212e-02,  5.4272e-01],
         [ 1.2508e-01, -8.7617e-01,  1.2223e+00,  3.2682e-01, -1.0487e-01,  2.4768e+00,  5.7691e-01,  1.4731e-01, -1.3136e+00, -6.0611e-01],
         [ 6.4498e-01, -2.4771e-01, -1.4078e+00, -8.0111e-02,  5.1941e-01,  1.1709e+00,  2.1780e+00,  1.7792e+00,  2.5832e-01, -2.4341e+00],
         [-3.4975e-01, -1.3381e+00, -4.3891e-01, -5.8502e-01,  1.8071e+00, -7.3262e-01,  4.0940e-01, -5.8410e-01,  1.0613e-01, -3.0671e-01],
         [ 8.6423e-01, -1.0659e+00, -1.0130e+00, -9.9392e-01,  2.9083e+00,  1.4483e+00, -5.6145e-01, -9.4646e-01, -7.4197e-01,  1.5562e-01],
         [-2.5844e-01, -7.5015e-01,  1.2355e+00,  1.0141e+00,  1.0132e+00,  6.3464e-01,  8.7688e-01,  8.1428e-01,  1.9737e-01, -6.3676e-01],
         [-8.7683e-01, -1.5510e+00, -7.8818e-01,  5.6844e-01,  7.6224e-01,  5.5685e-01,  1.2984e+00,  1.7561e+00,  2.1129e-01,  1.4860e+00]],

        [[ 5.5851e-01,  3.4915e-01,  8.4837e-01,  2.0355e+00,  3.7721e-01,  4.8435e-01, -3.0399e-02,  1.0925e+00, -5.0640e-01, -8.4417e-01],
         [-2.2144e-01,  2.2746e+00, -7.8324e-01, -2.6778e-01,  1.5685e+00, -2.8351e-01, -9.6035e-02,  1.0644e+00,  1.4888e+00,  8.8256e-01],
         [-2.3840e-01,  5.4687e-01, -6.0580e-02, -5.3049e-01, -2.0364e+00,  5.2469e-01, -6.9703e-01, -8.7932e-02, -2.7431e-01,  1.2923e+00],
         [-1.4459e+00, -3.1467e-01,  1.1260e-01, -1.4679e+00, -1.7168e+00, -5.5025e-01,  5.3508e-01, -1.3392e+00,  1.2358e+00, -2.0371e+00],
         [ 1.4171e+00,  1.6868e-01, -1.1421e+00,  6.0696e-01, -8.3318e-01, -4.7921e-01,  2.9985e-01,  7.2138e-01, -6.1845e-01,  5.4566e-01],
         [-7.6913e-01,  7.9336e-02, -7.5847e-01,  9.4199e-01,  4.3399e-01,  1.1234e+00,  5.0576e-01, -1.1371e+00, -7.5818e-01,  4.2283e-02],
         [-6.9009e-01, -5.6215e-01,  8.2530e-01,  2.2683e+00, -1.7733e+00, -9.9073e-01,  6.3486e-01,  1.0238e+00,  9.5747e-01,  1.9130e-02],
         [-1.0700e+00, -7.5189e-01,  2.4401e+00, -1.9129e+00,  3.1077e-01, -1.4763e+00, -4.7829e-01, -1.1728e-01, -6.3051e-01, -1.2655e+00],
         [-2.9485e-01, -2.7986e-01,  1.0837e+00,  1.7298e-01,  5.1235e-01, -9.8185e-01,  1.1259e+00,  2.5539e-01, -4.5890e-01, -9.2838e-01],
         [-1.7175e-01, -6.8667e-01, -1.3269e-01,  1.6296e+00, -1.5457e+00, -1.6960e-01,  2.7817e-02,  9.1074e-02,  6.7185e-01,  9.8518e-01]],

        [[-7.6097e-01, -1.2726e+00, -6.2674e-01,  1.3713e+00,  2.3598e-01, -4.4657e-01, -1.1778e+00,  1.4125e+00, -2.3167e-02, -1.1093e-02],
         [-9.9528e-01, -2.9935e-01,  7.6703e-01, -9.3721e-01, -2.3305e+00, -7.8088e-01,  8.2501e-01,  1.2207e+00, -6.2976e-02,  1.1464e+00],
         [ 1.2215e+00, -3.1373e-01, -7.2343e-01, -3.6273e-01,  4.4249e-01,  1.9418e-01, -4.9999e-01, -5.5005e-01,  2.3852e-02, -1.5204e+00],
         [ 5.2940e-01, -3.9083e-01, -1.9291e+00,  3.4977e-02, -4.8336e-01, -1.2261e+00, -3.3964e-01,  7.3262e-03, -5.2180e-02,  1.1675e+00],
         [ 1.7302e+00,  2.0562e+00, -2.3472e-01, -1.3456e+00, -5.1658e-01, -6.8817e-01,  4.7550e-01, -1.4316e+00,  1.4277e-01,  6.3289e-01],
         [-1.0489e+00, -5.2246e-01, -1.1338e+00, -1.4128e-01, -6.4563e-01,  4.1014e-01,  3.2672e-01, -8.3443e-01, -4.9217e-01,  6.5804e-01],
         [ 5.3619e-01,  1.2350e+00, -2.1214e-01,  1.3873e+00, -8.2485e-01,  3.5450e-01, -2.8074e-01, -2.4326e-01, -2.9366e-01, -6.2867e-01],
         [-4.2267e-02, -2.7005e-01,  1.4388e+00,  3.2586e-02, -5.4797e-01, -4.9368e-01,  2.8819e+00, -1.1672e+00,  1.9413e+00, -1.1636e+00],
         [-1.5967e+00,  8.3206e-02, -9.2221e-01, -3.7114e-01, -9.7143e-01,  1.5282e-01,  7.2510e-01, -1.3895e+00,  1.1874e+00,  2.7558e-02],
         [ 2.0011e+00, -1.2461e-01, -1.1565e+00,  9.0100e-01, -1.8843e-01, -1.2726e+00,  5.7646e-01, -3.5594e-01, -5.1885e-01, -3.9274e-01]],

        [[ 1.7512e+00,  1.9589e-01,  1.7758e+00, -1.8523e-01,  1.0595e+00,  1.2978e+00,  3.2856e-01,  1.4869e-01,  2.7044e-01, -1.1818e+00],
         [-1.0340e+00, -4.9475e-01, -8.9512e-01,  5.3402e-01, -8.8661e-01,  7.9637e-01,  6.5883e-01, -2.9667e-01,  2.3320e-01, -1.3473e+00],
         [-8.2310e-01, -5.3947e-01,  9.2151e-02,  8.5391e-01, -1.0332e+00,  5.8380e-01,  1.0166e+00, -7.9419e-01,  3.6743e-01,  4.2930e-01],
         [ 2.0289e+00, -7.6839e-01, -1.2263e+00, -1.1335e-01,  3.0849e-01, -4.4106e-01, -7.7970e-01, -7.5657e-01,  1.5148e+00, -1.5796e+00],
         [ 6.3864e-01, -4.3614e-01, -1.0023e+00,  3.7803e-01,  4.2760e-02,  5.8587e-01, -1.3688e+00,  1.1169e+00,  2.7693e-01,  1.0580e+00],
         [-5.1479e-02,  1.7128e-01, -2.1165e-01, -1.7876e-01, -8.4983e-01,  1.1670e+00, -3.4847e-01,  7.4182e-02,  1.7575e+00, -6.2545e-01],
         [ 2.0936e-01,  1.5050e+00, -1.1346e+00, -7.1118e-01,  1.3401e+00,  1.5109e+00, -1.1985e+00,  3.7666e-01, -2.5113e-01, -5.2773e-01],
         [-4.7699e-01, -5.6253e-01, -1.0563e+00,  2.4131e-01,  1.8275e-01,  6.2465e-01, -7.9398e-01, -6.7484e-01, -3.8769e-01,  4.4965e-01],
         [ 3.7261e-01, -1.9105e+00,  2.6085e-01,  1.4178e+00,  6.7380e-01,  1.4666e+00, -1.1077e+00, -7.4438e-01,  1.0189e+00, -1.8317e+00],
         [ 2.8062e-01,  6.9092e-01,  7.1838e-01, -5.7193e-01, -4.6663e-01,  1.0177e-01,  3.8034e-01, -1.9629e+00, -7.8058e-01, -1.3440e-01]],

        [[-3.6094e-01,  1.0463e-01, -3.2587e-01,  3.1892e-01, -1.0977e-01,  9.6497e-02, -1.4932e+00,  5.2380e-01,  7.5307e-01, -2.2192e-01],
         [ 5.8191e-01, -1.9369e+00, -1.5334e+00, -1.7966e-01, -6.5778e-01, -1.2317e+00, -1.2464e+00, -1.4996e+00, -5.4040e-01,  1.2410e+00],
         [-1.6212e+00, -9.0360e-01,  1.3968e+00,  9.1782e-01,  5.1204e-01, -8.4058e-01, -1.0445e+00,  5.5477e-01, -9.4926e-01,  1.0457e+00],
         [-1.1298e+00, -2.8006e+00,  1.2797e+00,  2.2000e-01,  3.2491e-01,  1.3190e+00, -8.4968e-01, -6.9870e-01, -2.0516e-01, -7.8117e-01],
         [ 6.8727e-01,  7.8359e-01, -1.1109e+00, -3.1063e+00, -9.8977e-01, -6.0220e-01, -7.1534e-01, -4.6740e-01,  5.5142e-01,  2.6549e+00],
         [ 1.0582e+00, -1.4682e-01, -8.9133e-01,  1.9379e-01,  1.9682e+00, -7.4036e-01, -8.6657e-01, -3.0639e-01, -5.3594e-01, -3.5751e-01],
         [-1.2399e+00, -1.5235e+00, -8.1588e-01,  1.1373e+00,  2.1926e-01,  4.1337e-01,  6.1524e-03, -5.6728e-01, -1.7038e-01, -3.0279e-01],
         [-1.2868e+00, -1.3663e+00, -4.6252e-02, -6.1496e-01,  1.2367e+00, -8.1436e-01,  1.1462e+00, -1.1787e+00, -3.6673e-02,  6.7181e-01],
         [ 9.2423e-01,  2.6972e-01,  6.2854e-01, -7.0662e-01, -8.5584e-01,  9.0406e-01, -5.6593e-01,  3.8410e-01, -7.8158e-01, -1.5094e-01],
         [ 4.1993e-01,  1.4059e+00, -8.2709e-01,  1.5608e+00, -1.0952e+00,  1.1855e+00,  1.1881e+00,  2.0556e+00,  6.6027e-01, -1.1078e+00]],

        [[-2.9196e-01,  4.5644e-01, -3.1470e-01, -4.1329e-01,  3.9462e-01,  1.1305e+00,  8.2584e-01,  9.4583e-01, -1.5447e-01, -1.6013e+00],
         [-5.9471e-02, -9.9287e-01,  1.1634e+00,  1.6095e+00, -2.9417e-01,  1.0819e+00,  8.8662e-01, -8.6114e-01, -2.7265e-01,  9.8042e-01],
         [-1.7533e-01, -1.2277e-01,  7.4141e-01,  3.5395e-01, -5.3458e-01,  6.4537e-01, -2.9891e+00,  1.8371e-01, -4.7270e-01, -9.5882e-01],
         [-1.5124e+00,  1.5068e+00, -9.3805e-01, -6.3851e-01,  2.1947e-01, -4.3924e-01, -1.3911e-01, -1.8692e-02,  1.6561e+00,  1.0661e+00],
         [-1.8189e-01, -1.2380e+00,  5.1422e-01, -1.5104e-01,  1.3774e-01,  1.2251e+00, -7.6426e-01,  9.1838e-01,  4.0577e-01,  2.5105e-01],
         [ 1.2815e-01, -1.9803e-01, -1.4780e+00, -5.9103e-01,  8.3575e-01, -2.2925e-01, -1.2404e+00,  2.4919e-01, -1.1416e+00,  7.8214e-01],
         [ 1.0817e-02,  3.8163e-01, -1.6527e+00, -3.8140e-01,  1.0699e-01, -1.0150e-01,  8.3015e-02,  7.1201e-01, -9.0059e-01,  8.9069e-01],
         [ 4.7655e-01, -8.3963e-01,  3.3320e-01, -1.2526e+00, -5.7455e-01, -1.9059e+00, -9.6654e-01,  3.6773e-01, -5.7858e-01,  1.2373e+00],
         [ 8.7134e-01, -5.2276e-01,  1.2400e+00, -9.0577e-01,  7.6803e-01,  1.6222e+00,  8.1580e-02,  2.0282e-01,  3.3024e-01, -9.5337e-01],
         [ 1.5735e+00,  1.8697e+00, -1.0639e+00, -2.2726e-01,  2.5006e-01,  1.1618e+00, -1.1422e-01, -5.6295e-02,  8.4975e-01, -8.5991e-01]],

        [[-6.1057e-01,  1.0629e+00,  1.2222e+00,  7.7189e-01, -1.2797e+00, -1.5433e+00, -6.0202e-01,  3.2140e-01, -6.0616e-02, -1.1704e+00],
         [-2.7736e+00, -2.9824e-02, -9.1662e-01,  4.7027e-01,  1.8778e+00,  5.2237e-01,  5.1757e-02,  4.2602e-01,  9.4751e-01,  4.3643e-01],
         [-2.0531e-01, -1.4739e+00,  5.0663e-01,  2.7792e-01,  1.3515e+00, -8.9496e-01, -1.5961e+00,  6.7372e-01, -9.9707e-01, -3.4807e-01],
         [ 2.1768e-01,  1.1278e+00, -1.5005e+00, -2.4048e-01, -4.8549e-01, -6.6165e-02, -9.0293e-01,  6.4402e-01,  7.5918e-01, -2.0203e+00],
         [-6.7395e-01, -9.1921e-01,  1.2120e+00, -1.3463e+00, -4.8316e-01,  1.7186e+00, -5.6843e-01, -2.9151e+00,  1.0834e+00,  7.7311e-02],
         [ 1.2317e+00,  2.9194e+00,  1.9378e+00, -5.5362e-01, -1.3030e+00,  1.0696e+00, -4.5618e-01,  1.3635e+00, -2.4220e+00, -8.3080e-02],
         [ 1.0349e-01,  1.1661e-01, -2.5220e-02,  3.7887e-01,  2.4456e-01, -8.9158e-01,  1.4344e+00, -1.9292e+00, -5.7138e-01, -6.6717e-01],
         [-9.2035e-02,  9.5487e-01,  1.8483e-01, -1.1677e-01, -2.2911e-01, -3.4486e-01, -1.0765e+00, -5.4777e-01, -3.2893e-01,  5.8413e-02],
         [ 2.1100e+00,  7.7261e-01, -3.4265e-01,  1.2370e+00,  5.2633e-01,  1.2554e-01, -1.7527e+00,  7.7516e-01, -1.0627e-01,  8.9080e-01],
         [-7.7323e-01,  1.3246e+00, -4.6587e-01,  4.9164e-01, -2.6584e-01,  7.2558e-01,  1.0841e+00, -3.5993e-01, -2.5479e-02, -1.5332e-01]]])
        index = torch.tensor([[5, 2, 5, 6, 4, 0, 5, 9, 0, 4],
        [7, 3, 5, 8, 3, 6, 1, 8, 3, 3],
        [9, 3, 7, 4, 5, 3, 7, 8, 7, 0],
        [1, 3, 6, 9, 6, 0, 1, 0, 3, 5],
        [6, 8, 4, 0, 1, 9, 8, 9, 1, 9],
        [7, 4, 8, 5, 2, 4, 8, 1, 3, 5]])
        weights = torch.tensor([1.0000, 1.5000, 2.0000, 1.0000, 1.5000, 2.0000])
        mask = torch.tensor([[False,  True,  True, False,  True,  True, False, False, False,  True],
        [ True,  True, False, False,  True,  True, False, False, False, False],
        [ True, False,  True,  True,  True, False, False, False, False,  True],
        [False, False,  True, False,  True,  True,  True,  True,  True,  True],
        [ True,  True, False, False, False, False,  True, False,  True, False],
        [False, False,  True, False,  True,  True, False, False, False,  True]])
        
        torch.set_printoptions(threshold=float('inf'), linewidth=200, profile='full')
        # print(logits)
        # print(index)
        # print(weights)
        # print(mask)
        # Call function
        result = selective_log_softmax(logits, index, weights, mask)
        
        # print(result)
        expected_result = torch.tensor([[-5.2761, -3.0658, -2.6624, -4.0221, -3.6729, -3.5824, -3.8072, -4.9864, -6.5733, -2.6731],
        [-3.1693, -3.4744, -4.4209, -3.8921, -3.9464, -3.2954, -3.1604, -4.3959, -4.7487, -4.9540],
        [-3.8240, -3.7874, -4.2457, -5.3651, -3.4098, -2.7242, -4.5721, -4.1435, -4.6703, -4.3488],
        [-3.6311, -4.3477, -3.5754, -4.0799, -3.0481, -3.4460, -4.3019, -4.5827, -3.2800, -3.5174],
        [-3.9249, -4.0163, -4.8912, -6.4485, -5.4410, -2.7956, -3.8895, -2.2337, -2.3877, -6.0751],
        [-4.0685, -1.7506, -3.3635, -2.6542, -3.7226, -4.0425, -4.2533, -3.5384, -2.8534, -2.9582]])

        torch.testing.assert_close(result, expected_result, atol=1e-4, rtol=1e-4)
        # Verify output shape
        expected_shape = (num_iterations * batch_size, seq_len)
        self.assertEqual(result.shape, expected_shape,
                        f"Output shape should be {expected_shape}")
        
        # Verify output is finite
        self.assertTrue(torch.isfinite(result).all(),
                       "Output should all be finite values")
    
    def test_selective_log_softmax_uniform_weights(self):
        """Test behavior when using uniform weights"""
        num_iterations = 1
        batch_size = 2
        seq_len = 5
        
        logits = torch.tensor([[[ 1.9269e+00,  1.4873e+00,  9.0072e-01, -2.1055e+00,  6.7842e-01, -1.2345e+00, -4.3067e-02, -1.6047e+00, -7.5214e-01,  1.6487e+00],
         [-3.9248e-01, -1.4036e+00, -7.2788e-01, -5.5943e-01, -7.6884e-01,  7.6245e-01,  1.6423e+00, -1.5960e-01, -4.9740e-01,  4.3959e-01],
         [-7.5813e-01,  1.0783e+00,  8.0080e-01,  1.6806e+00,  1.2791e+00,  1.2964e+00,  6.1047e-01,  1.3347e+00, -2.3162e-01,  4.1759e-02],
         [-2.5158e-01,  8.5986e-01, -1.3847e+00, -8.7124e-01, -2.2337e-01,  1.7174e+00,  3.1888e-01, -4.2452e-01,  3.0572e-01, -7.7459e-01],
         [-1.5576e+00,  9.9564e-01, -8.7979e-01, -6.0114e-01, -1.2742e+00,  2.1228e+00, -1.2347e+00, -4.8791e-01, -9.1382e-01, -6.5814e-01]],

        [[ 7.8024e-02,  5.2581e-01, -4.8799e-01,  1.1914e+00, -8.1401e-01, -7.3599e-01, -1.4032e+00,  3.6004e-02, -6.3477e-02,  6.7561e-01],
         [-9.7807e-02,  1.8446e+00, -1.1845e+00,  1.3835e+00,  1.4451e+00,  8.5641e-01,  2.2181e+00,  5.2317e-01,  3.4665e-01, -1.9733e-01],
         [-1.0546e+00,  1.2780e+00, -1.7219e-01,  5.2379e-01,  5.6622e-02,  4.2630e-01,  5.7501e-01, -6.4172e-01, -2.2064e+00, -7.5080e-01],
         [ 1.0868e-02, -3.3874e-01, -1.3407e+00, -5.8537e-01,  5.3619e-01,  5.2462e-01,  1.1412e+00,  5.1644e-02,  7.4395e-01, -4.8158e-01],
         [-1.0495e+00,  6.0390e-01, -1.7223e+00, -8.2777e-01,  1.3347e+00,  4.8354e-01, -2.5095e+00,  4.8800e-01,  7.8459e-01,  2.8647e-02]],

        [[ 6.4076e-01,  5.8325e-01,  1.0669e+00, -4.5015e-01, -1.8527e-01,  7.5276e-01,  4.0476e-01,  1.7847e-01,  2.6491e-01,  1.2732e+00],
         [-1.3109e-03, -3.0360e-01, -1.4570e+00, -1.0234e-01, -5.9915e-01,  4.7706e-01,  7.2618e-01,  9.1152e-02, -3.8907e-01,  5.2792e-01],
         [-1.2685e-02,  2.4084e-01,  1.3254e-01,  7.6424e-01,  1.0950e+00,  3.3989e-01,  7.1997e-01,  4.1141e-01,  1.9312e+00,  1.0119e+00],
         [-1.4364e+00, -1.1299e+00, -1.3603e-01,  1.6354e+00,  6.5474e-01,  5.7600e-01,  1.1415e+00,  1.8565e-02, -1.8058e+00,  9.2543e-01],
         [-3.7534e-01,  1.0331e+00, -6.8665e-01,  6.3681e-01, -9.7267e-01,  9.5846e-01,  1.6192e+00,  1.4506e+00,  2.6948e-01, -2.1038e-01]],

        [[-7.3280e-01,  1.0430e-01,  3.4875e-01,  9.6759e-01, -4.6569e-01,  1.6048e+00, -2.4801e+00, -4.1754e-01, -1.1955e+00,  8.1234e-01],
         [-1.9006e+00,  2.2858e-01,  2.4859e-02, -3.4595e-01,  2.8683e-01, -7.3084e-01,  1.7482e-01, -1.0939e+00, -1.6022e+00,  1.3529e+00],
         [ 1.2888e+00,  5.2295e-02, -1.5469e+00,  7.5671e-01,  7.7552e-01,  2.0265e+00,  3.5818e-02,  1.2059e-01, -8.0566e-01, -2.0758e-01],
         [-9.3195e-01, -1.5910e+00, -1.1360e+00, -5.2260e-01, -5.1877e-01, -1.5013e+00, -1.9267e+00,  1.2785e-01,  1.0229e+00, -5.5580e-01],
         [ 7.0427e-01,  7.0988e-01,  1.7744e+00, -9.2155e-01,  9.6245e-01, -3.3702e-01, -1.1753e+00,  3.5806e-01,  4.7877e-01,  1.3537e+00]],

        [[ 5.2606e-01,  2.1120e+00, -5.2076e-01, -9.3201e-01,  1.8516e-01,  1.0687e+00,  1.3065e+00,  4.5983e-01, -8.1463e-01, -1.0212e+00],
         [-4.9492e-01, -5.9225e-01,  1.5432e-01,  4.4077e-01, -1.4829e-01, -2.3184e+00, -3.9800e-01,  1.0805e+00, -1.7809e+00,  1.5080e+00],
         [ 3.0943e-01, -5.0031e-01,  1.0350e+00,  1.6896e+00, -4.5051e-03,  1.6668e+00,  1.5392e-01, -1.0603e+00, -5.7266e-01,  8.3568e-02],
         [ 3.9991e-01,  1.9892e+00, -7.1988e-02, -9.0609e-01, -2.0487e+00, -1.0811e+00,  1.7623e-02,  7.8226e-02,  1.9316e-01,  4.0967e-01],
         [-9.2913e-01,  2.7619e-01, -5.3888e-01,  4.6258e-01, -8.7189e-01, -2.7118e-02, -3.5325e-01,  1.4639e+00,  1.2554e+00, -7.1496e-01]],

        [[ 8.5392e-01,  5.1299e-01,  5.3973e-01,  5.6551e-01,  5.0579e-01,  2.2245e-01, -6.8548e-01,  5.6356e-01, -1.5072e+00, -1.6107e+00],
         [-1.4790e+00,  4.3227e-01, -1.2503e-01,  7.8212e-01, -1.5988e+00, -1.0913e-01,  7.1520e-01,  3.9139e-02,  1.3059e+00,  2.4659e-01],
         [-1.9776e+00,  1.7896e-02, -1.3793e+00,  6.2580e-01, -2.5850e+00, -2.4000e-02, -1.2219e-01, -7.4700e-01,  1.7093e+00,  5.7923e-02],
         [ 1.1930e+00,  1.9373e+00,  7.2871e-01,  9.8089e-01, -5.5719e-01, -9.6835e-01,  8.7128e-01, -9.5641e-02,  4.0380e-01, -7.1398e-01],
         [ 8.3373e-01, -9.5855e-01,  1.0682e+00, -2.5272e-01, -1.8815e-01, -7.7115e-01,  1.7989e-01, -2.1268e+00, -1.3408e-01, -1.0408e+00]]])
        index = torch.tensor([[8, 8, 6, 1, 5],
        [8, 1, 9, 1, 1]])
        
        # Use uniform weights
        weights = torch.ones(num_iterations * 3)
        mask = torch.tensor([[False, False,  True,  True, False],
        [False,  True, False,  True,  True]])
        
        # print(logits)
        # print(index)
        # print(weights)
        # print(mask)
        result = selective_log_softmax(logits, index, weights=weights, mask=mask)
        # print(result)
        expected_result = torch.tensor([[-3.8760, -3.7005, -2.5297, -2.8752, -1.6137],
        [-3.3045, -1.8622, -2.8402, -3.2120, -2.1513]])

        torch.testing.assert_close(result, expected_result, atol=1e-4, rtol=1e-4)
        # Verify output shape and validity
        self.assertEqual(result.shape, (num_iterations * batch_size, seq_len))
        self.assertTrue(torch.isfinite(result).all(),
                       "Output should all be finite values when using uniform weights")
    
    def test_selective_log_softmax_weighted_averaging(self):
        """Test correctness of weighted averaging"""
        num_iterations = 1
        batch_size = 1
        seq_len = 3
        
        # Create controllable logits
        logits = torch.zeros(3, seq_len, self.vocab_size)
        # Set different logits for each version
        logits[0, :, 0] = 10.0  # Version 1: token 0 has high probability
        logits[1, :, 1] = 10.0  # Version 2: token 1 has high probability
        logits[2, :, 2] = 10.0  # Version 3: token 2 has high probability
        
        index = torch.zeros(1, seq_len, dtype=torch.long)  # All select token 0
        weights = torch.tensor([1.0, 2.0, 3.0])
        mask = torch.tensor([[True, False, True]])  # Positions 0 and 2 are masked
        
        result = selective_log_softmax(logits, index, weights, mask)
        
        # Manually calculate expected result
        # For each position:
        # - If mask=True: final = (logp1 + logp2 * weight2) / 2
        # - If mask=False: final = (logp1 + logp3 * weight3) / 2
        
        logp1 = F.log_softmax(logits[0], dim=-1).gather(dim=-1, index=index[0].unsqueeze(-1)).squeeze(-1)
        logp2 = F.log_softmax(logits[1], dim=-1).gather(dim=-1, index=index[0].unsqueeze(-1)).squeeze(-1)
        logp3 = F.log_softmax(logits[2], dim=-1).gather(dim=-1, index=index[0].unsqueeze(-1)).squeeze(-1)
        
        expected = torch.zeros(1, seq_len)
        for j in range(seq_len):
            if mask[0, j]:
                expected[0, j] = (logp1[j] + logp2[j] * weights[1]) / 2
            else:
                expected[0, j] = (logp1[j] + logp3[j] * weights[2]) / 2
        
        torch.testing.assert_close(result, expected, atol=1e-5, rtol=1e-5)
    

    
    def test_selective_log_softmax_mask_effect(self):
        """Test effect of mask on results"""
        num_iterations = 1
        batch_size = 1
        seq_len = 4
        
        logits = torch.tensor([[[ 1.9269,  1.4873,  0.9007, -2.1055,  0.6784, -1.2345, -0.0431, -1.6047, -0.7521,  1.6487],
         [-0.3925, -1.4036, -0.7279, -0.5594, -0.7688,  0.7624,  1.6423, -0.1596, -0.4974,  0.4396],
         [-0.7581,  1.0783,  0.8008,  1.6806,  1.2791,  1.2964,  0.6105,  1.3347, -0.2316,  0.0418],
         [-0.2516,  0.8599, -1.3847, -0.8712, -0.2234,  1.7174,  0.3189, -0.4245,  0.3057, -0.7746]],

        [[-1.5576,  0.9956, -0.8798, -0.6011, -1.2742,  2.1228, -1.2347, -0.4879, -0.9138, -0.6581],
         [ 0.0780,  0.5258, -0.4880,  1.1914, -0.8140, -0.7360, -1.4032,  0.0360, -0.0635,  0.6756],
         [-0.0978,  1.8446, -1.1845,  1.3835,  1.4451,  0.8564,  2.2181,  0.5232,  0.3466, -0.1973],
         [-1.0546,  1.2780, -0.1722,  0.5238,  0.0566,  0.4263,  0.5750, -0.6417, -2.2064, -0.7508]],

        [[ 0.0109, -0.3387, -1.3407, -0.5854,  0.5362,  0.5246,  1.1412,  0.0516,  0.7440, -0.4816],
         [-1.0495,  0.6039, -1.7223, -0.8278,  1.3347,  0.4835, -2.5095,  0.4880,  0.7846,  0.0286],
         [ 0.6408,  0.5832,  1.0669, -0.4502,  1.0311, -0.7048,  1.0131, -0.3308,  0.5177,  0.3878],
         [-0.5797, -0.1691, -0.5733,  0.5069, -0.4752, -0.4920,  0.2704, -0.5628,  0.6793,  0.4405]]])
        index = torch.tensor([[6, 8, 0, 6]])
        weights = torch.tensor([1.0, 1.5, 2.0])
        # print(logits)
        # print(index)
        
        # Test all-True mask
        mask_all_true = torch.ones(1, seq_len, dtype=torch.bool)
        result_all_true = selective_log_softmax(logits, index, weights, mask_all_true)
        expected_result_all_true = torch.tensor([[-4.5118, -3.4198, -4.6574, -2.5899]])
        # print(result_all_true)
        # Test all-False mask
        mask_all_false = torch.zeros(1, seq_len, dtype=torch.bool)
        result_all_false = selective_log_softmax(logits, index, weights, mask_all_false)
        expected_result_all_false = torch.tensor([[-3.0005, -3.3135, -4.2045, -3.2197]])
        # print(result_all_false)

        torch.testing.assert_close(result_all_true, expected_result_all_true, atol=1e-4, rtol=1e-4)
        torch.testing.assert_close(result_all_false, expected_result_all_false, atol=1e-4, rtol=1e-4)
        # Two results should be different (because different versions were used)
        self.assertFalse(torch.allclose(result_all_true, result_all_false),
                        "Different masks should produce different results")
        
        # Verify results are all finite
        self.assertTrue(torch.isfinite(result_all_true).all())
        self.assertTrue(torch.isfinite(result_all_false).all())
    
    
    def test_selective_log_softmax_gather_correctness(self):
        """Test correctness of gather operation"""
        num_iterations = 1
        batch_size = 2
        seq_len = 3
        vocab_size = 10
        
        # Create simple logits
        # Order should be: [v1_seq0, v1_seq1, v2_seq0, v2_seq1, v3_seq0, v3_seq1]
        logits = torch.randn(3 * batch_size, seq_len, vocab_size)
        index = torch.tensor([[0, 1, 2], [3, 4, 5]])  # Specify token IDs to extract
        weights = torch.tensor([1.0, 1.0, 1.0])
        mask = torch.tensor([[True, True, False], [False, True, True]])
        
        result = selective_log_softmax(logits, index, weights, mask)
        
        # Manually verify first position of first sequence
        # According to implementation, logits index is: base + version*batch_size + offset
        # For seq0: base=0, offset=0
        # v1: 0 + 0*2 + 0 = 0
        # v2: 0 + 1*2 + 0 = 2
        # v3: 0 + 2*2 + 0 = 4
        seq0_logits_v1 = logits[0, 0]  # Version 1, seq 0
        seq0_logits_v2 = logits[2, 0]  # Version 2, seq 0
        seq0_logp_v1 = F.log_softmax(seq0_logits_v1, dim=-1)[index[0, 0]]
        seq0_logp_v2 = F.log_softmax(seq0_logits_v2, dim=-1)[index[0, 0]]
        
        # mask[0,0]=True, so use Version 2
        expected_value = (seq0_logp_v1 + seq0_logp_v2 * weights[1]) / 2
        
        self.assertAlmostEqual(result[0, 0].item(), expected_value.item(), places=5)
    
    def test_selective_log_softmax_weight_indexing(self):
        """Test correctness of weight indexing"""
        num_iterations = 2
        batch_size = 1
        seq_len = 2
        
        logits = torch.tensor([[[ 1.9269,  1.4873,  0.9007, -2.1055,  0.6784, -1.2345, -0.0431, -1.6047, -0.7521,  1.6487],
         [-0.3925, -1.4036, -0.7279, -0.5594, -0.7688,  0.7624,  1.6423, -0.1596, -0.4974,  0.4396]],

        [[-0.7581,  1.0783,  0.8008,  1.6806,  1.2791,  1.2964,  0.6105,  1.3347, -0.2316,  0.0418],
         [-0.2516,  0.8599, -1.3847, -0.8712, -0.2234,  1.7174,  0.3189, -0.4245,  0.3057, -0.7746]],

        [[-1.5576,  0.9956, -0.8798, -0.6011, -1.2742,  2.1228, -1.2347, -0.4879, -0.9138, -0.6581],
         [ 0.0780,  0.5258, -0.4880,  1.1914, -0.8140, -0.7360, -1.4032,  0.0360, -0.0635,  0.6756]],

        [[-0.0978,  1.8446, -1.1845,  1.3835,  1.4451,  0.8564,  2.2181,  0.5232,  0.3466, -0.1973],
         [-1.0546,  1.2780, -0.1722,  0.5238,  0.0566,  0.4263,  0.5750, -0.6417, -2.2064, -0.7508]],

        [[ 0.0109, -0.3387, -1.3407, -0.5854,  0.5362,  0.5246,  1.1412,  0.0516,  0.7440, -0.4816],
         [-1.0495,  0.6039, -1.7223, -0.8278,  1.3347,  0.4835, -2.5095,  0.4880,  0.7846,  0.0286]],

        [[ 0.6408,  0.5832,  1.0669, -0.4502,  1.0311, -0.7048,  1.0131, -0.3308,  0.5177,  0.3878],
         [-0.5797, -0.1691, -0.5733,  0.5069, -0.4752, -0.4920,  0.2704, -0.5628,  0.6793,  0.4405]]])
        index = torch.tensor([[6, 8],
        [0, 6]])
        
        # print(logits)
        # print(index)
        # Set different weights for each iteration
        weights = torch.tensor([1.0, 2.0, 3.0, 1.0, 4.0, 5.0])  # Two iterations
        mask = torch.ones(num_iterations * batch_size, seq_len, dtype=torch.bool)
        
        result = selective_log_softmax(logits, index, weights, mask)
        
        # print(result)

        expected_result = torch.tensor([[ -4.2258,  -3.8572],
        [ -6.8542, -11.1240]])
        # Verify each iteration used correct weights
        # First iteration should use weights[0:3]
        # Second iteration should use weights[3:6]
        torch.testing.assert_close(result, expected_result, atol=1e-4, rtol=1e-4)
        self.assertEqual(result.shape, (num_iterations * batch_size, seq_len))
        self.assertTrue(torch.isfinite(result).all())
    
    def test_selective_log_softmax_edge_cases(self):
        """Test edge cases"""
        # Test 1: Single sequence
        logits_single = torch.tensor([[[ 1.9269,  1.4873,  0.9007, -2.1055,  0.6784, -1.2345, -0.0431, -1.6047, -0.7521,  1.6487]],

        [[-0.3925, -1.4036, -0.7279, -0.5594, -2.3169, -0.2168, -1.3847, -0.8712, -0.2234,  1.7174]],

        [[ 0.3189, -0.4245, -0.8286,  0.3309, -1.5576,  0.9956, -0.8798, -0.6011, -1.2742,  2.1228]]])
        index_single = torch.tensor([[3]])

        # print(logits_single)
        # print(index_single)
        weights_single = torch.tensor([1.0, 1.0, 1.0])
        mask_single = torch.tensor([[True]])
        
        result_single = selective_log_softmax(logits_single, index_single, weights_single, mask_single)

        expected_result_single = torch.tensor([[-4.0467]])
        # print(result_single)
        self.assertEqual(result_single.shape, (1, 1))
        self.assertTrue(torch.isfinite(result_single).all())
        
        # Test 2: Long sequence
        long_seq_len = 100
        logits_long = torch.tensor([[[-3.5529e-01, -9.1382e-01, -6.5814e-01,  7.8024e-02,  5.2581e-01, -4.8799e-01,  1.1914e+00, -8.1401e-01, -1.2862e+00, -1.4032e+00],
         [ 3.6004e-02, -6.3477e-02,  6.7561e-01, -9.7807e-02,  1.8446e+00, -1.1845e+00, -4.4585e-01,  1.4451e+00,  8.5641e-01,  2.2181e+00],
         [ 5.2317e-01,  3.4665e-01, -1.9733e-01, -1.0546e+00, -7.7178e-01, -1.7219e-01,  5.2379e-01,  5.6622e-02,  4.2630e-01,  5.7501e-01],
         [-6.4172e-01, -2.2064e+00,  1.6992e+00,  1.0868e-02, -3.3874e-01, -1.3407e+00, -5.8537e-01,  5.3619e-01,  5.2462e-01,  1.1412e+00],
         [ 1.4332e+00,  7.4395e-01, -4.8158e-01, -1.0495e+00,  6.0390e-01, -1.7223e+00, -8.2777e-01,  1.3347e+00,  4.7466e-01, -2.5095e+00],
         [ 4.8800e-01,  7.8459e-01,  2.8647e-02,  6.4076e-01,  5.8325e-01,  1.0669e+00,  5.5263e-01, -1.8527e-01,  7.5276e-01,  4.0476e-01],
         [ 1.7847e-01,  2.6491e-01,  1.2732e+00, -1.3109e-03,  4.0981e-01, -1.4570e+00, -1.0234e-01, -5.9915e-01,  4.7706e-01,  7.2618e-01],
         [ 9.1152e-02, -3.8907e-01,  1.2795e+00, -1.2685e-02,  2.4084e-01,  1.3254e-01,  7.6424e-01,  1.0950e+00,  3.3989e-01,  7.1997e-01],
         [-1.6912e-01,  1.9312e+00,  1.0119e+00, -1.4364e+00, -1.1299e+00, -1.3603e-01,  1.6354e+00,  6.5474e-01,  4.4053e-01,  1.1415e+00],
         [ 1.8565e-02, -1.8058e+00,  9.2543e-01, -3.7534e-01,  1.0331e+00, -6.8665e-01, -1.1633e-01, -9.7267e-01,  9.5846e-01,  1.6192e+00],
         [ 1.4506e+00,  2.6948e-01, -2.1038e-01, -7.3280e-01,  5.2138e-01,  3.4875e-01,  9.6759e-01, -4.6569e-01,  1.6048e+00, -2.4801e+00],
         [-4.1754e-01, -1.1955e+00,  6.5264e-01, -1.9006e+00,  2.2858e-01,  2.4859e-02, -3.4595e-01,  2.8683e-01, -7.3084e-01,  1.7482e-01],
         [-3.0975e-01, -1.6022e+00,  1.3529e+00,  1.2888e+00,  5.2295e-02, -1.5469e+00,  7.5671e-01,  7.7552e-01, -3.9000e-01,  3.5818e-02],
         [ 1.2059e-01, -8.0566e-01, -2.0758e-01, -9.3195e-01, -1.5910e+00, -1.1360e+00,  8.0325e-01, -5.1877e-01, -1.5013e+00, -1.9267e+00],
         [ 1.2785e-01,  1.0229e+00, -5.5580e-01,  7.0427e-01, -5.9219e-01,  1.7744e+00, -9.2155e-01,  9.6245e-01, -3.3702e-01, -1.1753e+00],
         [ 3.5806e-01,  4.7877e-01, -7.1691e-01,  5.2606e-01,  2.1120e+00, -5.2076e-01, -9.3201e-01,  1.8516e-01,  1.0687e+00,  1.3065e+00],
         [ 3.2546e-01, -8.1463e-01, -1.0212e+00, -4.9492e-01, -5.9225e-01,  1.5432e-01,  4.4077e-01, -1.4829e-01, -3.3502e-02, -3.9800e-01],
         [ 1.0805e+00, -1.7809e+00,  1.5080e+00,  3.0943e-01, -5.0031e-01,  1.0350e+00,  7.0473e-01, -4.5051e-03,  1.6668e+00,  1.5392e-01],
         [-1.0603e+00, -5.7266e-01,  8.3568e-02,  3.9991e-01, -7.2403e-01, -7.1988e-02, -9.0609e-01, -2.0487e+00, -1.0811e+00,  1.7623e-02],
         [ 7.8226e-02,  1.9316e-01, -1.2931e-01, -9.2913e-01,  2.7619e-01, -5.3888e-01,  4.6258e-01, -8.7189e-01, -2.7118e-02, -3.5325e-01],
         [-2.2136e-01,  1.2554e+00, -7.1496e-01,  8.5392e-01,  5.1299e-01,  5.3973e-01,  5.6551e-01,  5.0579e-01, -1.8847e-02, -6.8548e-01],
         [ 5.6356e-01, -1.5072e+00, -1.6107e+00, -1.4790e+00,  4.3227e-01, -1.2503e-01,  2.1962e-01, -1.5988e+00, -1.0913e-01,  7.1520e-01],
         [ 3.9139e-02,  1.3059e+00,  2.4659e-01, -1.9776e+00,  8.5404e-02, -1.3793e+00,  6.2580e-01, -2.5850e+00, -2.4000e-02, -1.2219e-01],
         [-7.4700e-01,  1.7093e+00,  1.2588e-03,  1.1930e+00,  1.9373e+00,  7.2871e-01,  9.8089e-01,  4.1459e-01,  1.1566e+00,  2.6905e-01],
         [ 3.3700e-01,  9.7329e-01, -1.0151e+00, -5.4192e-01, -4.4102e-01, -3.1362e-01, -1.2925e-01, -7.1496e-01,  2.1698e+00,  2.0207e+00],
         [ 2.5392e-01,  9.3644e-01,  7.1224e-01, -3.1766e-02,  1.0164e-01,  1.3433e+00, -9.5641e-02,  4.0380e-01, -7.1398e-01,  8.3373e-01],
         [-9.5855e-01,  4.5363e-01,  1.2461e+00, -2.3065e+00, -7.7115e-01,  1.7989e-01, -2.1268e+00, -1.3408e-01, -1.0408e+00, -7.6472e-01],
         [-5.5283e-02,  1.2049e+00,  1.3596e+00,  4.3344e-01, -7.1719e-01,  1.0554e+00, -1.4534e+00,  4.6515e-01,  3.7139e-01, -4.6568e-03],
         [ 5.6080e-02,  3.7818e-01,  7.0511e-01, -1.7237e+00, -8.4348e-01,  4.3514e-01,  2.6589e-01, -5.8710e-01,  4.9340e-01,  8.8538e-01],
         [ 1.8244e-01,  7.8638e-01, -5.7920e-02,  5.6667e-01, -7.0976e-01, -4.8751e-01,  1.7512e-01,  6.0841e-01,  1.6309e+00, -8.4723e-02],
         [ 1.0844e+00,  9.4777e-01, -6.7663e-01, -5.7302e-01,  1.7060e+00, -7.9394e-01,  3.7523e-01,  8.7910e-02, -1.2415e+00, -3.2025e-01],
         [-8.4438e-01, -5.5135e-01, -2.5189e-01,  1.9003e+00,  1.6951e+00,  2.8090e-02, -1.7537e-01, -1.7735e+00, -7.0464e-01, -3.9465e-01],
         [-2.8006e-02, -2.1844e-01,  1.6630e-01,  2.1442e+00,  1.7046e+00,  3.4590e-01,  6.4248e-01, -2.0395e-01,  5.0667e-01, -1.3969e-01],
         [-1.1808e+00, -1.2829e+00,  4.4849e-01, -5.9074e-01,  8.5406e-01, -4.9007e-01, -5.8542e-01,  6.6637e-01, -7.4265e-02, -2.0960e-01],
         [ 1.6632e-01,  1.4703e+00, -9.3909e-01, -6.0132e-01,  2.1882e+00, -9.8515e-01, -2.4885e+00, -3.3132e-01,  8.4358e-01,  9.8745e-01],
         [-3.3197e-01, -8.0762e-01, -5.4650e-02,  2.4700e-02, -1.0641e+00, -7.6019e-01, -4.0751e-01,  9.6236e-01, -1.4264e-01,  1.5271e-01],
         [ 7.8999e-01,  9.4461e-01, -1.5824e+00,  9.8713e-01,  1.1457e+00, -1.4181e-01, -2.7634e-01, -1.9321e-01,  2.2285e-01,  6.8388e-01],
         [-1.3246e+00, -5.1608e-01,  6.0018e-01, -4.7022e-01, -6.0864e-01, -4.6192e-02, -7.3959e-01, -4.8333e-01, -7.4029e-01,  3.1428e-01],
         [ 1.4156e-01,  1.0348e+00, -6.2644e-01, -5.1509e-01, -9.9475e-01, -4.9400e-01,  1.1366e+00, -4.6184e-01,  1.4200e+00,  8.4852e-01],
         [-4.7891e-02,  6.6856e-01, -3.9834e-01,  6.8990e-01, -1.3129e+00,  3.7804e-02, -1.1702e+00, -1.0319e-01,  1.1895e+00,  7.6069e-01],
         [-1.6917e+00, -1.3839e+00,  4.8687e-01, -1.0020e+00,  3.2949e-02, -4.2920e-01, -9.8180e-01, -6.4206e-01, -1.3291e+00,  1.5914e+00],
         [-1.2081e-01, -4.8302e-01,  1.1330e-01,  7.7151e-02, -9.2281e-01, -1.2620e+00,  1.5193e-01,  1.0966e+00, -6.8369e-01,  6.6043e-02],
         [-7.7380e-04,  1.6206e-01,  1.1960e+00, -1.3062e+00, -5.4189e-01, -1.0597e+00,  3.0573e-01,  4.1506e-01, -7.1741e-01,  2.8340e+00],
         [ 1.9535e+00,  2.0487e+00, -1.1774e+00,  1.6217e+00,  8.5127e-01, -4.0047e-01, -6.0883e-01, -5.0810e-01, -6.1849e-01, -1.6470e+00],
         [ 6.8631e-01, -4.5031e-01, -7.2966e-02, -5.4795e-01, -1.1426e+00, -4.4875e-01, -3.0454e-02,  3.8303e-01,  8.3139e-01,  1.1799e+00],
         [-3.3143e-01,  6.4950e-01,  9.4959e-02, -7.5259e-01, -6.4723e-01, -1.2823e+00, -8.5015e-01, -9.6385e-01, -2.5668e+00,  7.0961e-01],
         [ 8.1984e-01,  6.2145e-01,  4.2319e-01, -3.3890e-01, -2.8780e-01, -1.3638e+00,  1.9296e-01, -6.1033e-01,  1.6323e-01,  1.5102e+00],
         [ 2.1230e-01, -7.2520e-01,  3.0508e-02,  5.2169e-01, -4.6387e-01,  1.8238e-01, -3.8666e-01, -1.7907e+00,  9.3293e-02, -1.9153e+00],
         [-1.3341e+00,  1.3439e+00, -1.2922e+00,  7.6624e-01,  6.4540e-01,  3.5332e-01, -2.6475e+00, -1.4575e+00,  1.5819e-01,  2.5403e-01],
         [-1.7906e-01,  1.1993e+00, -4.2922e-01,  1.0103e+00,  6.1104e-01,  1.2208e+00, -7.5627e-02, -1.7376e+00, -1.2535e-01, -1.3658e+00],
         [ 1.1117e+00, -6.2280e-01, -7.8918e-01, -1.6782e-01, -1.3313e+00,  2.0071e+00, -1.2531e+00,  1.1189e+00,  1.7733e+00, -2.0717e+00],
         [-4.1253e-01, -9.7696e-01,  1.3264e-02,  1.8595e+00,  2.6221e+00,  3.6905e-01,  3.8030e-01,  1.9898e-01, -2.3609e-01,  3.0341e-01],
         [ 3.3843e+00,  4.7390e-01,  6.5034e-01,  1.1662e+00,  1.6936e-02,  5.3259e-01, -6.0354e-01, -1.7426e-01,  8.6857e-01, -8.0322e-01],
         [-1.1209e+00,  1.9564e-01, -7.8152e-01, -1.7899e+00, -2.6157e-01, -4.4025e-01, -3.3326e-01, -4.8010e-01, -1.2872e+00,  7.3888e-01],
         [ 3.3895e-02, -3.1229e-01, -2.5418e-01, -1.2055e+00, -2.1818e+00,  6.1277e-02,  8.5261e-02,  7.4813e-01, -1.6356e-01, -9.0856e-01],
         [ 3.1300e-01,  8.0505e-01, -8.3081e-01,  4.9816e-01, -1.2000e+00,  1.2711e-01,  4.4037e-01,  6.3777e-01,  1.5979e-01,  1.7698e+00],
         [-1.0375e+00, -1.8737e+00,  2.3259e+00, -9.2039e-01,  6.6611e-01, -4.4026e-01, -2.3180e+00,  1.2946e+00, -8.6795e-02, -8.4834e-01],
         [ 1.6489e+00,  1.6006e+00, -7.8589e-02,  4.3105e-01,  3.6835e-01,  7.6380e-01, -2.6476e-02, -4.1379e-01,  5.1841e-01, -7.0154e-01],
         [-4.3234e-01,  1.4148e-01,  7.1104e-02,  5.6335e-01,  7.0497e-01, -1.0838e+00, -3.8893e-01,  8.1261e-01,  1.4981e+00,  4.3896e-02],
         [ 1.4443e+00,  2.3203e-01, -7.8841e-01, -1.2787e+00, -3.8427e-02,  1.9138e+00,  3.3784e-01,  1.2506e-01, -7.6215e-01, -1.1906e+00],
         [ 5.9373e-01,  4.5572e-01,  2.5033e-01, -1.3611e+00,  1.8018e+00, -7.4342e-02, -1.5664e-01, -8.7085e-01,  1.6028e-01, -4.1456e-01],
         [-6.9024e-01, -2.2996e-01, -2.1723e+00,  8.7683e-02,  1.0938e+00, -1.1772e-01, -2.0952e+00, -9.5362e-01, -9.2473e-02, -1.0167e+00],
         [-7.6757e-03, -5.1822e-01,  8.3954e-01,  5.8523e-02, -1.4080e+00,  2.1296e+00, -1.5181e+00,  1.3873e-01, -1.1798e+00, -5.2974e-01],
         [ 9.6252e-01,  2.7944e-01,  7.5923e-01, -2.7936e+00, -7.1115e-01,  5.2352e-01, -1.7106e+00,  8.3849e-01, -2.6985e-01,  1.2306e-01],
         [ 2.2069e-01,  1.5133e-01,  7.3939e-01,  2.7310e-01,  2.7312e+00,  4.3201e-01, -3.0918e-01, -9.6581e-02, -8.8802e-01, -1.0874e-01],
         [-4.1890e-01,  1.4384e+00, -7.0684e-01, -1.2520e+00,  3.0250e+00,  1.3463e+00, -5.5455e-02,  3.2203e-01,  4.4606e-01,  1.5230e+00],
         [ 1.2805e+00, -1.1616e-01,  1.3705e+00, -4.8094e-01, -4.0626e-01, -1.3642e+00,  8.2057e-03, -4.0586e-01, -7.1109e-01, -3.4958e-01],
         [ 3.7975e-01,  9.9930e-01,  8.1006e-01,  9.5949e-01,  1.0351e-01,  8.2903e-01,  2.0921e+00,  7.9531e-01,  2.7928e-01,  1.8645e-01],
         [ 4.7021e-01,  9.0639e-02,  1.7423e+00, -1.2660e+00,  3.8916e-01,  3.4288e-01, -1.4591e+00, -1.4937e+00,  2.1726e+00,  2.2524e-01],
         [-7.7245e-02,  9.8569e-01,  1.2783e+00,  2.8815e-01,  8.6905e-01, -8.0971e-01, -3.5021e-01,  4.5902e-01,  5.3093e-01, -1.3615e+00],
         [ 1.9562e+00,  1.7685e+00, -9.8580e-01, -1.2371e+00,  1.4659e+00, -1.0087e-03, -8.4943e-01, -1.6594e+00,  3.0629e-01,  1.1820e+00],
         [ 3.2603e-01, -3.8945e-01, -1.3310e-01,  8.2437e-01,  7.9835e-01,  1.8890e+00,  5.9346e-01,  6.9654e-02, -1.6034e+00, -4.2982e-01],
         [-2.1307e-01,  3.4436e-01, -3.1016e+00, -1.4587e+00, -1.4318e+00, -6.0713e-01, -2.5974e-01, -7.1902e-01,  1.3794e-01,  5.2335e-01],
         [-8.2118e-01, -4.7087e-01,  6.0164e-01, -2.8251e-01,  7.6927e-01, -7.6689e-01,  8.0115e-01,  1.6917e-02,  8.0277e-02,  7.4484e-01],
         [ 1.3455e+00,  1.2682e-01, -2.4521e+00,  4.1598e-01, -1.3005e+00, -7.3467e-01,  4.4657e-02, -1.5211e+00,  3.4784e-01,  7.4018e-01],
         [ 1.4162e+00,  6.8340e-01, -1.4576e-01,  9.2130e-01,  5.2824e-01, -8.2284e-03, -1.4493e+00, -6.0518e-01, -1.7925e-01,  1.9956e-01],
         [-2.9836e+00, -4.1460e-01,  1.4559e+00,  3.3165e-01, -1.0001e+00, -6.9195e-01, -4.7199e-01, -1.2894e+00, -1.9229e-02, -1.0667e+00],
         [-1.9893e+00,  2.9731e-01,  4.3446e-01,  3.3933e-03, -1.0240e+00,  2.2405e-01,  9.8853e-01,  1.3676e+00, -3.1974e-01, -9.1309e-01],
         [ 1.9192e+00, -1.6515e+00,  2.1477e+00, -6.6041e-01,  1.7225e-01, -2.2057e-01,  7.1181e-01,  3.4159e-01,  1.5886e+00, -3.4888e-01],
         [-4.5792e-01, -1.2322e+00,  1.1242e+00, -2.8155e-01,  5.2819e-02,  4.2498e-01,  4.8258e-01,  4.8813e-01,  1.0082e+00, -5.9500e-01],
         [ 2.8529e-02,  8.2297e-01, -8.8603e-01,  1.4801e+00,  8.3915e-01, -2.0005e-01,  9.9495e-01,  7.2019e-01, -1.0228e+00, -1.4068e+00],
         [-2.3610e+00, -2.9049e-01, -1.3346e-01, -1.5693e-01,  1.1383e+00, -2.5052e-01,  7.7438e-01, -5.4527e-01, -2.1582e+00, -1.6608e+00],
         [-6.6374e-01,  3.6579e-01, -3.9920e-01,  4.9674e-01, -9.9987e-02, -5.6147e-01, -5.9491e-01,  1.2687e+00,  1.2904e+00, -1.1756e+00],
         [-7.8323e-02, -9.7058e-01, -7.1499e-01,  1.4109e+00, -1.3144e+00, -1.3162e+00, -1.2524e+00, -1.5844e+00, -2.5447e+00,  1.3719e+00],
         [ 7.4105e-01,  7.3784e-01, -8.5053e-01,  3.6101e-02,  1.3407e+00,  9.2000e-01, -3.7876e-01, -1.5598e+00, -1.4606e+00, -7.1111e-01],
         [-3.8667e-01,  9.5783e-01, -8.2253e-01, -2.3908e+00,  3.2225e-01,  1.8754e+00, -1.4655e-02, -5.2238e-01, -7.4018e-01,  1.6236e-01],
         [-2.3700e-01,  5.0993e-01,  1.6706e+00,  1.5921e+00, -1.9508e+00,  1.8619e+00, -1.0779e+00,  8.8486e-01, -8.3421e-01,  1.0301e+00],
         [-8.6810e-01, -5.7016e-01,  1.3824e+00,  1.1285e+00, -1.2123e+00,  2.6024e+00, -9.5724e-02, -8.1148e-02,  1.2587e+00,  8.6913e-01],
         [-1.4395e-01,  5.1823e-02, -3.2848e-01, -2.2472e+00, -4.4790e-01,  4.2347e-01, -3.8746e-01, -2.2964e-01,  1.7930e+00,  8.7030e-01],
         [-1.0553e+00, -1.3284e+00,  7.0607e-01,  3.5730e-01,  5.8928e-01,  9.1878e-01, -2.4554e-01,  2.4651e-01,  1.3287e-01,  1.2191e-01],
         [ 4.7809e-01,  2.7613e-01, -5.8957e-01,  5.6918e-01,  8.7324e-01, -1.9897e-01, -1.3616e+00, -5.1936e-01,  7.6482e-02,  3.4005e-01],
         [ 1.4557e+00, -3.4610e-01, -1.0805e+00, -4.4770e-01, -7.2882e-01, -1.6066e-01, -3.2064e-01, -6.3077e-01, -7.8877e-01,  1.3062e+00],
         [ 6.5922e-01, -2.6274e-01,  9.3150e-01, -4.5935e-01, -9.4195e-01, -7.0892e-01,  2.1861e+00, -6.4932e-01,  9.5321e-01,  8.5207e-01],
         [-1.6947e+00,  1.1806e+00, -2.8929e+00, -3.8758e-01, -7.1240e-01, -1.6171e+00, -4.5605e-01,  5.1367e-02,  6.9502e-01,  1.8352e+00],
         [-1.9180e+00, -1.3924e+00,  5.4047e-01,  4.3507e-01,  1.5792e+00, -1.3386e-01, -5.8557e-02,  1.2574e-01, -5.5258e-01,  7.4480e-02],
         [-1.4929e-01, -5.5225e-01,  2.9771e-01, -1.0284e+00,  4.0444e-01,  2.1426e+00, -5.1537e-01,  1.0827e+00,  1.2499e+00,  9.8214e-01],
         [ 1.4148e-01,  4.9279e-01, -5.1283e-01,  3.0062e-01,  7.7347e-02,  6.4777e-01, -4.3242e-01,  1.1740e+00, -8.5345e-01,  6.6743e-01],
         [-8.0360e-01, -1.3776e+00, -4.4105e-01,  1.4176e-01,  1.1085e+00,  5.5442e-01, -1.2450e-01, -1.2248e+00,  9.6289e-01, -1.5785e+00],
         [ 6.7160e-01, -6.0152e-02,  6.9784e-02, -1.6635e+00,  6.2465e-01,  1.2306e+00,  4.2521e-01, -1.6383e-02, -1.0749e-01, -1.3086e+00],
         [ 6.5981e-01, -7.0325e-02, -4.3199e-01, -3.4501e-01, -1.1962e-01,  1.1862e+00, -1.2203e+00,  2.9100e-01, -7.9642e-02,  1.3200e+00]],

        [[-9.9579e-01, -2.9336e-01,  2.1066e+00, -1.0875e-01,  6.0834e-01,  7.8943e-01,  7.8247e-01, -6.4659e-02,  1.1653e+00,  6.8309e-01],
         [ 1.0637e-01,  3.5032e-01,  1.2110e-01,  2.9843e-01,  1.3448e+00,  1.4614e+00, -1.6847e-01,  8.1554e-01, -8.2406e-01,  8.9328e-01],
         [-3.8688e-01, -3.5718e-01, -1.1568e+00, -1.7660e+00, -1.2469e+00,  9.6943e-02, -7.9121e-01,  3.7120e-01,  1.5118e+00, -8.9146e-01],
         [ 5.2475e-01,  3.5178e-01,  1.3402e+00,  1.1900e+00,  1.4109e+00,  7.9801e-01,  4.9413e-01, -1.8495e-01, -1.0381e+00, -1.0130e-01],
         [-1.7395e+00,  2.3484e-01,  8.8615e-02, -3.4769e-01,  8.4907e-01,  2.0147e-01,  3.8398e-01,  1.2310e+00, -3.3510e-01,  7.0421e-01],
         [-5.6285e-02, -1.4897e+00, -1.5195e+00,  3.2581e-01, -1.4584e+00,  1.8989e+00,  3.1875e+00, -2.9337e-01,  1.3978e+00, -9.1666e-01],
         [-7.7937e-01, -4.1754e-01,  1.1060e+00,  2.5285e-01,  5.8132e-01,  7.7053e-01, -1.1304e+00,  9.9646e-01, -1.1810e+00,  9.6260e-01],
         [-1.1049e+00, -7.9095e-01,  1.5023e+00,  1.9485e-03, -2.0979e-01,  1.2010e+00,  6.7560e-01, -1.8900e+00,  1.9432e-01,  1.6020e+00],
         [-1.4565e-02, -7.4869e-01, -3.8440e-01,  1.4350e-01, -8.1268e-02,  1.1262e+00,  4.0618e-02, -6.4642e-02,  7.3334e-01, -1.1129e+00],
         [-4.3420e-01, -1.5212e-02,  5.4272e-01,  1.2508e-01, -8.7617e-01,  1.2223e+00,  4.0705e-01, -1.0487e-01,  2.4768e+00,  5.7691e-01],
         [ 1.4731e-01, -1.3136e+00, -6.0611e-01,  6.4498e-01,  2.0517e+00, -1.4078e+00, -8.0111e-02,  5.1941e-01,  1.1709e+00,  2.1780e+00],
         [ 1.7792e+00,  2.5832e-01, -5.7640e-01, -3.4975e-01, -1.3381e+00, -4.3891e-01, -5.8502e-01,  1.8071e+00, -7.3262e-01,  4.0940e-01],
         [ 3.1265e-01,  1.0613e-01, -3.0671e-01,  8.6423e-01, -1.0659e+00, -1.0130e+00, -9.9392e-01,  2.9083e+00, -1.2018e+00, -5.6145e-01],
         [-9.4646e-01, -7.4197e-01,  1.5562e-01, -2.5844e-01, -7.5015e-01,  1.2355e+00,  3.6662e-01,  1.0132e+00,  6.3464e-01,  8.7688e-01],
         [ 8.1428e-01,  1.9737e-01, -6.3676e-01, -8.7683e-01, -2.6485e-01, -7.8818e-01,  5.6844e-01,  7.6224e-01,  5.5685e-01,  1.2984e+00],
         [ 1.7561e+00,  2.1129e-01, -9.5914e-01,  5.5851e-01,  3.4915e-01,  8.4837e-01,  2.0355e+00,  3.7721e-01,  4.8435e-01, -3.0399e-02],
         [ 1.7599e-01, -5.0640e-01, -8.4417e-01, -2.2144e-01,  2.2746e+00, -7.8324e-01, -2.6778e-01,  1.5685e+00,  1.1752e+00, -9.6035e-02],
         [ 1.0644e+00,  1.4888e+00,  8.8256e-01, -2.3840e-01,  5.4687e-01, -6.0580e-02,  2.2441e+00, -2.0364e+00,  5.2469e-01, -6.9703e-01],
         [-8.7932e-02, -2.7431e-01,  1.2923e+00, -1.4459e+00,  1.0887e+00,  1.1260e-01, -1.4679e+00, -1.7168e+00, -5.5025e-01,  5.3508e-01],
         [-1.3392e+00,  1.2358e+00, -7.5812e-01,  1.4171e+00,  1.6868e-01, -1.1421e+00,  6.0696e-01, -8.3318e-01, -4.7921e-01,  2.9985e-01],
         [ 1.0514e+00, -6.1845e-01,  5.4566e-01, -7.6913e-01,  7.9336e-02, -7.5847e-01,  9.4199e-01,  4.3399e-01, -2.7424e-01,  5.0576e-01],
         [-1.1371e+00, -7.5818e-01,  4.2283e-02, -6.9009e-01, -5.6215e-01,  8.2530e-01, -3.2912e-01, -1.7733e+00, -9.9073e-01,  6.3486e-01],
         [ 1.0238e+00,  9.5747e-01,  1.9130e-02, -1.0700e+00, -5.2993e-01,  2.4401e+00, -1.9129e+00,  3.1077e-01, -1.4763e+00, -4.7829e-01],
         [-1.1728e-01, -6.3051e-01,  1.4172e+00, -2.9485e-01, -2.7986e-01,  1.0837e+00,  1.7298e-01,  5.1235e-01, -9.8185e-01,  1.1259e+00],
         [ 4.2050e-01, -4.5890e-01, -9.2838e-01, -1.7175e-01, -6.8667e-01, -1.3269e-01,  1.6296e+00, -1.5457e+00, -1.5250e+00,  2.7817e-02],
         [ 9.1074e-02,  6.7185e-01,  9.8518e-01, -7.6097e-01, -1.2726e+00, -6.2674e-01, -1.5551e+00,  2.3598e-01, -4.4657e-01, -1.1778e+00],
         [ 1.4125e+00, -2.3167e-02, -1.1093e-02, -9.9528e-01, -2.4478e+00,  7.6703e-01, -9.3721e-01, -2.3305e+00, -7.8088e-01,  8.2501e-01],
         [ 1.2207e+00, -6.2976e-02, -8.7102e-01,  1.2215e+00, -3.1373e-01, -7.2343e-01, -3.6273e-01,  4.4249e-01,  1.9418e-01, -4.9999e-01],
         [ 8.3665e-01,  2.3852e-02, -1.5204e+00,  5.2940e-01, -3.9083e-01, -1.9291e+00,  3.4977e-02, -4.8336e-01, -2.1411e+00, -3.3964e-01],
         [ 7.3262e-03, -5.2180e-02,  1.1675e+00,  1.7302e+00,  2.0562e+00, -2.3472e-01, -4.1529e-01, -5.1658e-01, -6.8817e-01,  4.7550e-01],
         [-1.4316e+00,  1.4277e-01,  6.3289e-01, -1.0489e+00,  1.3524e+00, -1.1338e+00, -1.4128e-01, -6.4563e-01,  4.1014e-01,  3.2672e-01],
         [-8.3443e-01, -4.9217e-01,  5.9639e-01,  5.3619e-01,  1.2350e+00, -2.1214e-01,  1.3873e+00, -8.2485e-01,  3.5450e-01, -2.8074e-01],
         [ 7.2589e-01, -2.9366e-01, -6.2867e-01, -4.2267e-02, -2.7005e-01,  1.4388e+00,  3.2586e-02, -5.4797e-01,  1.3450e+00,  2.8819e+00],
         [-1.1672e+00,  1.9413e+00, -1.1636e+00, -1.5967e+00,  8.3206e-02, -9.2221e-01,  6.7231e-01, -9.7143e-01,  1.5282e-01,  7.2510e-01],
         [-1.3895e+00,  1.1874e+00,  2.7558e-02,  2.0011e+00,  1.0925e+00, -1.1565e+00,  9.0100e-01, -1.8843e-01, -1.2726e+00,  5.7646e-01],
         [-3.5594e-01, -5.1885e-01,  6.4057e-01,  1.7512e+00,  1.9589e-01,  1.7758e+00, -1.8523e-01,  1.0595e+00,  1.2978e+00,  3.2856e-01],
         [-1.0801e+00,  2.7044e-01, -1.1818e+00, -1.0340e+00, -4.9475e-01, -8.9512e-01,  5.3402e-01, -8.8661e-01,  3.9128e-02,  6.5883e-01],
         [-2.9667e-01,  2.3320e-01, -1.3473e+00, -8.2310e-01, -5.3947e-01,  9.2151e-02,  1.1937e-01, -1.0332e+00,  5.8380e-01,  1.0166e+00],
         [-7.9419e-01,  3.6743e-01,  4.2930e-01,  2.0289e+00, -5.1530e-01, -1.2263e+00, -1.1335e-01,  3.0849e-01, -4.4106e-01, -7.7970e-01],
         [-7.5657e-01,  1.5148e+00, -2.0070e-01,  6.3864e-01, -4.3614e-01, -1.0023e+00,  3.7803e-01,  4.2760e-02,  5.8587e-01, -1.3688e+00],
         [-1.4919e+00,  2.7693e-01,  1.0580e+00, -5.1479e-02,  1.7128e-01, -2.1165e-01, -1.7876e-01, -8.4983e-01, -2.7287e-01, -3.4847e-01],
         [ 7.4182e-02,  1.7575e+00, -6.2545e-01,  2.0936e-01,  1.5050e+00, -1.1346e+00,  4.4789e-01,  1.3401e+00,  1.5109e+00, -1.1985e+00],
         [ 3.7666e-01, -2.5113e-01, -5.2773e-01, -4.7699e-01, -5.4137e-01, -1.0563e+00,  2.4131e-01,  1.8275e-01,  6.2465e-01, -7.9398e-01],
         [-6.7484e-01, -3.8769e-01,  1.2539e+00,  3.7261e-01, -1.9105e+00,  2.6085e-01,  1.4178e+00,  6.7380e-01,  1.4666e+00, -1.1077e+00],
         [ 1.7926e+00,  1.0189e+00, -1.8317e+00,  2.8062e-01,  6.9092e-01,  7.1838e-01, -5.7193e-01, -4.6663e-01,  6.3893e-01,  3.8034e-01],
         [-1.9629e+00, -7.8058e-01, -1.3440e-01, -3.6094e-01,  1.0463e-01, -3.2587e-01,  6.0418e-01, -1.0977e-01,  9.6497e-02, -1.4932e+00],
         [ 5.2380e-01,  7.5307e-01, -2.2192e-01,  5.8191e-01, -2.8871e-01, -1.5334e+00, -1.7966e-01, -6.5778e-01, -1.2317e+00, -1.2464e+00],
         [-1.4996e+00, -5.4040e-01, -6.5027e-01, -1.6212e+00, -9.0360e-01,  1.3968e+00,  9.1782e-01,  5.1204e-01, -8.4058e-01, -1.0445e+00],
         [-7.9377e-01, -9.4926e-01,  1.0457e+00, -1.1298e+00, -2.8006e+00,  1.2797e+00,  2.2000e-01,  3.2491e-01,  6.4197e-01, -8.4968e-01],
         [-6.9870e-01, -2.0516e-01, -7.8117e-01,  6.8727e-01,  7.8359e-01, -1.1109e+00, -3.2067e-02, -9.8977e-01, -6.0220e-01, -7.1534e-01],
         [-4.6740e-01,  5.5142e-01,  2.6549e+00,  1.0582e+00,  3.5831e-01, -8.9133e-01,  1.9379e-01,  1.9682e+00, -7.4036e-01, -8.6657e-01],
         [-3.0639e-01, -5.3594e-01,  1.1350e+00, -1.2399e+00, -1.5235e+00, -8.1588e-01,  1.1373e+00,  2.1926e-01,  4.1337e-01,  6.1524e-03],
         [-1.3694e+00, -1.7038e-01, -3.0279e-01, -1.2868e+00, -1.3663e+00, -4.6252e-02, -6.1496e-01,  1.2367e+00,  5.3425e-01,  1.1462e+00],
         [-1.1787e+00, -3.6673e-02,  6.7181e-01,  9.2423e-01,  2.6972e-01,  6.2854e-01,  4.1387e-01, -8.5584e-01,  9.0406e-01, -5.6593e-01],
         [ 3.8410e-01, -7.8158e-01, -1.5094e-01,  4.1993e-01, -1.3158e+00, -8.2709e-01,  1.5608e+00, -1.0952e+00,  1.1855e+00,  1.1881e+00],
         [ 2.0556e+00,  6.6027e-01, -1.3093e+00, -2.9196e-01,  4.5644e-01, -3.1470e-01, -4.1329e-01,  3.9462e-01,  1.1305e+00,  8.2584e-01],
         [-1.6644e+00, -1.5447e-01, -1.6013e+00, -5.9471e-02, -9.9287e-01,  1.1634e+00,  1.6095e+00, -2.9417e-01, -1.7284e-01,  8.8662e-01],
         [-8.6114e-01, -2.7265e-01,  9.8042e-01, -1.7533e-01, -1.2277e-01,  7.4141e-01, -5.1158e-01, -5.3458e-01,  6.4537e-01, -2.9891e+00],
         [ 1.8371e-01, -4.7270e-01, -9.5882e-01, -1.5124e+00, -4.7911e-01, -9.3805e-01, -6.3851e-01,  2.1947e-01, -4.3924e-01, -1.3911e-01],
         [-1.8692e-02,  1.6561e+00, -5.0022e-01, -1.8189e-01, -1.2380e+00,  5.1422e-01, -1.5104e-01,  1.3774e-01,  1.2251e+00, -7.6426e-01],
         [ 4.0663e-01,  4.0577e-01,  2.5105e-01,  1.2815e-01, -1.9803e-01, -1.4780e+00, -5.9103e-01,  8.3575e-01,  2.7361e-01, -1.2404e+00],
         [ 2.4919e-01, -1.1416e+00,  7.8214e-01,  1.0817e-02,  3.8163e-01, -1.6527e+00, -6.8633e-01,  1.0699e-01, -1.0150e-01,  8.3015e-02],
         [ 7.1201e-01, -9.0059e-01,  8.9069e-01,  4.7655e-01, -1.3074e+00,  3.3320e-01, -1.2526e+00, -5.7455e-01, -1.9059e+00, -9.6654e-01],
         [ 3.6773e-01, -5.7858e-01, -9.1970e-01,  8.7134e-01, -5.2276e-01,  1.2400e+00, -9.0577e-01,  7.6803e-01,  1.6222e+00,  8.1580e-02],
         [-6.8256e-03,  3.3024e-01, -9.5337e-01,  1.5735e+00,  1.8697e+00, -1.0639e+00, -2.2726e-01,  2.5006e-01, -3.5470e-02, -1.1422e-01],
         [-5.6295e-02,  8.4975e-01, -8.5991e-01, -6.1057e-01,  1.0629e+00,  1.2222e+00,  7.0857e-01, -1.2797e+00, -1.5433e+00, -6.0202e-01],
         [ 3.2140e-01, -6.0616e-02, -1.1704e+00, -2.7736e+00, -5.0785e-01, -9.1662e-01,  4.7027e-01,  1.8778e+00,  5.2237e-01,  5.1757e-02],
         [ 4.2602e-01,  9.4751e-01,  3.1505e+00, -2.0531e-01, -1.4739e+00,  5.0663e-01,  2.7792e-01,  1.3515e+00, -8.9496e-01, -1.5961e+00],
         [-4.8199e-01, -9.9707e-01, -3.4807e-01,  2.1768e-01,  1.1278e+00, -1.5005e+00, -2.4048e-01, -4.8549e-01, -3.3594e-01, -9.0293e-01],
         [ 6.4402e-01,  7.5918e-01, -2.0203e+00, -6.7395e-01, -9.1921e-01,  1.2120e+00,  1.6401e+00, -4.8316e-01,  1.7186e+00, -5.6843e-01],
         [-2.9151e+00,  1.0834e+00,  7.7311e-02,  1.2317e+00, -1.4518e-01,  1.9378e+00, -5.5362e-01, -1.3030e+00,  1.0696e+00, -4.5618e-01],
         [ 1.3635e+00, -2.4220e+00,  1.9882e+00,  1.0349e-01,  1.1661e-01, -2.5220e-02,  3.7887e-01,  2.4456e-01, -8.9158e-01,  1.4344e+00],
         [-2.6157e+00, -5.7138e-01, -6.6717e-01, -9.2035e-02,  9.5487e-01,  1.8483e-01, -1.1677e-01, -2.2911e-01, -1.1567e+00, -1.0765e+00],
         [-5.4777e-01, -3.2893e-01,  5.8413e-02,  2.1100e+00,  7.7261e-01, -3.4265e-01, -4.0528e-01, -2.4977e-01,  2.2397e-01, -6.8755e-01],
         [-4.8984e-01,  3.9969e-01,  6.9820e-01,  5.2110e-02, -2.1163e-01,  5.9505e-02,  1.7286e+00,  2.9208e-01, -6.9259e-01, -8.4428e-01],
         [-3.2920e-01, -1.1403e-01,  1.7157e-01,  3.0044e-01,  1.6395e+00, -1.0744e+00,  3.2122e-01,  2.8923e-01,  3.5197e-01,  2.0988e+00],
         [ 1.3246e+00, -1.7715e+00,  9.6894e-02,  3.6735e-01,  4.7319e-01,  5.8768e-01,  1.8398e-01, -8.4259e-01, -1.5332e-01,  1.0872e+00],
         [ 6.8014e-01,  1.1617e+00, -1.7657e-01,  5.2144e-01, -2.3571e+00, -8.3512e-01, -1.3196e+00, -1.2966e+00,  3.2691e-01,  6.0646e-01],
         [-4.6069e-01, -8.8008e-01, -1.4766e+00,  9.8293e-01,  5.8674e-01,  1.1689e+00,  9.0257e-01, -1.7167e+00,  4.6178e-02,  9.3900e-02],
         [-1.3564e+00, -1.0603e+00, -5.4824e-01,  5.4476e-01,  1.5224e+00,  2.3515e-02,  2.8559e-01,  2.0343e-02,  9.2891e-01, -9.2389e-01],
         [-5.1114e-01, -7.0543e-01,  1.1545e+00, -1.7463e+00,  7.1034e-01, -1.0176e-01, -9.6634e-01, -1.4232e+00,  2.0860e+00,  6.1071e-01],
         [ 2.1427e-01, -1.7471e-01, -1.7561e+00,  1.4259e+00,  5.1272e-01, -4.0267e-01, -5.8892e-01,  2.6717e-02, -2.5021e-01, -9.1363e-02],
         [-5.2833e-01, -4.6433e-01, -1.5669e-01, -1.5964e+00, -2.1181e+00,  8.5622e-01,  4.3222e-01,  2.4113e-01, -5.4695e-02,  4.7713e-02],
         [-8.6376e-01, -1.1419e+00, -1.4974e-01,  1.3149e+00,  1.2471e+00, -2.5818e-01, -1.3405e+00, -5.5618e-01,  1.1731e+00,  6.8599e-01],
         [ 1.5930e-01, -4.1024e-01, -7.5883e-01,  1.6982e+00,  7.4369e-01, -3.2767e-02,  1.0600e+00,  3.9094e-03,  9.5111e-01, -1.8830e+00],
         [ 3.0457e-01, -7.0023e-01,  1.7811e+00, -2.9368e-01,  5.2430e-01,  1.0186e+00, -7.4714e-01,  1.1706e+00,  1.6411e+00,  4.2830e-01],
         [-1.0704e+00, -6.1595e-01, -1.0195e+00,  3.8482e-01,  9.8457e-01, -1.7715e+00,  4.3493e-01,  6.3124e-02, -6.8945e-01, -2.8298e-01],
         [ 6.6000e-01, -1.6193e-01, -1.7464e-01,  5.4842e-01,  4.5765e-01,  9.6769e-01, -6.6736e-01,  1.6183e+00, -2.6440e-01,  1.3541e+00],
         [ 6.4279e-01, -3.6971e-01, -2.4597e-01,  3.2938e-01,  6.9737e-01,  8.3422e-01, -1.0987e+00,  5.6748e-01, -7.2674e-01, -3.8325e+00],
         [ 1.1585e-01,  1.9915e+00,  1.0238e+00,  2.1327e+00,  2.3348e-01,  1.2005e+00, -2.8947e-01, -9.4450e-01, -1.7938e-01,  3.1205e-01],
         [ 7.1738e-01, -2.3028e-01,  7.1477e-01,  1.4437e+00, -9.3538e-01, -8.3326e-01, -9.5268e-01, -3.6367e-01, -1.2479e+00, -9.2614e-02],
         [ 6.5336e-01,  1.6370e-01, -6.4490e-01, -3.6954e-01, -4.7142e-01,  4.7792e-01,  8.5095e-01,  3.6884e-01,  1.0622e+00,  1.7639e+00],
         [-1.3962e+00,  9.1271e-01, -1.3906e+00, -7.0961e-01,  9.3080e-01, -4.2432e-01, -4.8217e-01,  4.7738e-01, -2.8945e+00,  4.9374e-01],
         [ 5.6121e-01, -1.7987e+00, -6.0785e-01, -5.8763e-01, -3.4518e-01, -7.2878e-01, -4.7999e-01,  7.3510e-01, -2.6932e-01,  4.5086e-01],
         [ 4.0917e-02, -6.9333e-02,  2.5858e-01,  4.7755e-01, -1.5479e+00, -1.2930e+00,  8.7957e-01,  7.3064e-02,  9.9674e-01,  1.0238e+00],
         [-1.2133e+00,  9.7445e-01, -9.9079e-01, -9.9276e-01, -2.5576e-01, -9.5857e-01, -5.7027e-01,  1.9282e-01,  3.8475e-01, -8.5958e-01],
         [-4.7418e-01,  1.2761e-01,  6.1011e-01, -1.2943e+00,  6.0384e-01,  1.1172e+00,  4.1639e-01,  6.7471e-01,  6.1027e-02, -9.5563e-01],
         [-7.7798e-01,  6.9351e-01, -4.3586e-01, -9.8245e-01, -9.0629e-01,  1.2596e+00,  2.2886e-01, -2.0043e+00,  5.5123e-03,  4.6033e-01],
         [ 1.1791e+00, -1.0106e+00, -6.2026e-01, -1.4549e+00,  1.1510e+00, -6.9602e-01,  5.1550e-01,  7.2376e-01, -1.8847e-01, -5.8210e-01],
         [-4.3516e-01, -1.2878e+00, -1.5076e+00, -1.7679e-01,  6.3981e-01,  6.9127e-01,  5.1990e-01, -7.5461e-01, -3.3411e-02, -8.2765e-01]],

        [[-2.6493e+00, -6.0023e-01, -5.7975e-02,  2.9749e-01,  1.6328e+00, -1.4954e+00, -2.9970e-01, -4.1446e-01, -2.8041e-01, -1.5083e+00],
         [-1.3664e+00,  9.6400e-01,  4.0458e-02,  2.4693e-01,  1.1251e-01, -5.3494e-01, -1.2675e-02,  2.0659e+00,  1.0178e+00, -1.9379e+00],
         [-5.4771e-01, -1.8266e-01, -1.2373e+00, -1.6857e-01, -9.4881e-01,  1.0380e-01, -6.9890e-01, -5.0138e-01, -1.7143e-01, -1.5410e+00],
         [-3.3021e-01, -7.3943e-01,  9.5938e-01,  1.7838e-01, -1.7935e-01, -5.5837e-01, -8.8041e-01, -8.7913e-01,  1.5491e+00,  1.5372e-02],
         [ 1.5774e+00, -4.4803e-01,  1.8764e+00, -8.9188e-01,  4.3932e-01, -1.0310e+00, -1.4264e+00,  7.1959e-01, -2.1408e-01, -1.3461e+00],
         [-5.3699e-02, -1.0823e+00,  3.1819e-01, -2.2309e+00, -1.0310e+00,  2.0589e-01,  7.4113e-01,  9.6092e-01, -1.2231e+00,  7.8281e-02],
         [-1.5562e-01,  4.0913e-01,  4.9892e-01, -1.0029e+00, -5.3205e-01, -5.3456e-01, -1.4052e+00,  1.8912e+00,  1.3595e+00, -8.4877e-01],
         [-1.8412e+00,  1.3573e+00, -1.0257e+00, -8.5824e-01, -4.7482e-01, -9.5811e-01, -3.3481e-01, -1.7463e+00,  2.9125e-01, -4.5711e-01],
         [-3.2834e-01,  4.1718e-01,  1.6658e+00, -1.8150e+00, -4.8884e-01,  3.1906e-01,  8.2072e-01,  2.6855e-01, -3.5657e-01, -1.9664e+00],
         [ 3.4756e-01, -3.8398e-01,  9.9964e-01, -4.1198e-01,  1.7921e+00, -7.6727e-01,  1.8074e+00, -1.3159e+00, -1.2854e-01,  1.3067e+00],
         [ 1.9134e-01,  1.3767e+00,  6.8920e-01,  4.3922e-01,  2.7122e-01,  1.1222e+00,  2.7943e+00, -8.4641e-02, -2.4345e-01, -1.4119e+00],
         [-1.0504e+00,  1.1106e+00, -5.0207e-01,  5.0677e-01,  2.8286e-01, -1.1814e+00, -9.0017e-01,  2.1022e+00,  1.3313e-01,  2.2425e-02],
         [ 6.4778e-01, -6.8478e-01, -7.9503e-01, -1.7334e+00,  1.1859e+00,  4.4658e-01,  1.1301e+00, -3.3336e-01,  8.3080e-01, -1.4336e+00],
         [-8.7562e-01,  9.3841e-03,  6.3043e-01,  8.6330e-01,  1.1420e+00,  3.1093e-01,  1.3541e-01, -7.9539e-01, -1.1213e+00,  8.5798e-01],
         [-1.6933e+00,  2.8936e-01,  1.2979e-01,  8.0258e-01,  8.9013e-01,  3.8470e-01,  1.7066e-01,  1.3613e+00, -2.5743e-01,  6.6737e-03],
         [-5.4354e-01, -1.4135e+00, -1.6556e-02, -1.0137e+00,  1.0019e+00,  8.6722e-01,  2.4496e-01,  1.3057e+00, -1.0610e+00, -4.0719e-02],
         [-8.5286e-02,  6.4619e-01,  9.4744e-01, -9.6434e-01, -5.5447e-02,  6.4874e-01, -1.5245e+00, -4.6295e-01, -2.1544e+00,  1.4023e+00],
         [ 3.8868e-01,  7.2546e-01, -1.3895e+00, -8.5527e-01, -1.5335e+00,  1.2889e-01,  3.9971e-01, -7.3773e-01,  8.8078e-01, -7.6626e-01],
         [ 1.4586e+00,  1.7724e+00,  3.2966e-01,  6.5873e-01,  1.0571e+00,  4.0178e-01,  6.6231e-01, -8.1579e-01,  1.7510e+00, -7.1193e-02],
         [-3.1906e-01,  9.8013e-01,  1.9659e-02, -6.1245e-02, -9.4227e-01,  1.4319e+00,  1.3153e-01, -1.8222e-01,  3.6604e-01, -6.7536e-01],
         [ 2.4295e-01, -1.2092e+00,  7.7677e-02,  1.7619e-01,  5.7886e-01,  1.5512e+00,  8.4444e-02, -2.8735e-01, -8.5611e-01, -1.3968e-02],
         [-2.7779e-01, -7.8568e-01,  4.6062e-01,  5.6622e-01,  1.1542e+00, -2.3972e+00,  1.2388e+00, -1.0243e+00,  7.9945e-01,  8.7001e-01],
         [ 7.0074e-02, -3.3851e-01, -9.5478e-02,  1.5840e-01,  1.6815e+00,  1.6116e+00, -7.9801e-02,  1.6326e+00, -2.2044e-01, -2.2251e-01],
         [ 1.3148e-01,  6.8301e-01,  7.5937e-01,  1.4818e+00,  1.6593e+00,  4.0999e-01, -9.3318e-04, -1.0838e-01,  4.7941e-01, -1.2923e+00],
         [ 2.3051e-01, -6.3885e-03, -3.7650e-01,  2.2679e+00,  9.9913e-01, -2.9818e-01, -7.5647e-01, -2.0477e-01, -8.3037e-01, -9.4348e-01],
         [ 2.0284e+00,  3.9312e-01,  4.1331e-01,  4.6390e-01, -2.9827e-02,  1.2715e+00, -4.3794e-01, -1.0124e+00, -1.4667e-01, -4.9659e-01],
         [ 3.6382e-01,  3.3970e-01,  1.2731e+00, -1.5371e+00,  1.7112e-01, -7.6420e-01, -4.4292e-01, -9.0904e-03,  2.5302e-01,  8.8957e-01],
         [ 2.0152e+00,  1.2288e-01, -2.0456e-01,  5.7904e-01, -1.9990e-01, -2.4691e+00, -1.6101e+00,  1.7437e+00, -3.8771e-01,  7.7233e-01],
         [-2.1118e-01,  8.4670e-01,  8.5032e-01,  1.8044e+00,  1.4647e+00,  2.9134e-01, -1.1625e+00, -4.7836e-01, -3.0398e-01, -5.1145e-02],
         [-6.0138e-01, -1.1444e+00, -1.1234e+00, -7.9458e-01, -5.6948e-01,  5.4942e-02,  6.4448e-01, -1.4184e+00, -8.9732e-01, -6.9965e-02],
         [ 4.9443e-01,  2.1871e+00,  1.1618e+00,  6.3469e-01, -7.5165e-01, -1.4113e+00,  1.8677e+00, -9.8216e-01, -9.5810e-01,  1.7746e+00],
         [ 1.5162e+00, -1.0466e+00, -1.0859e+00, -2.3220e-01,  8.9476e-01, -1.1954e-01,  7.8543e-01, -5.6178e-01, -4.7884e-01, -7.5233e-01],
         [-2.4198e+00,  7.1346e-01, -1.9506e+00, -6.0311e-01, -7.9420e-01,  2.3616e-02, -7.1655e-01,  9.3131e-01, -1.2568e-01,  2.1544e-01],
         [-1.2842e+00,  2.2291e+00,  8.2494e-01,  4.5539e-01,  5.5991e-01,  2.1209e-01, -7.2481e-01,  2.8820e-01,  1.6998e+00,  2.4325e+00],
         [ 2.5851e-01,  1.3330e+00,  1.2649e-01, -1.5771e-01,  1.0092e-01,  1.2233e+00,  7.9177e-01,  5.0744e-01,  4.3917e-01, -8.3579e-01],
         [-6.9006e-01,  4.6465e-01,  2.2349e-01,  4.1360e-01, -5.2391e-01,  1.3423e-01, -1.1246e+00,  1.3094e+00, -7.2855e-02,  1.1227e+00],
         [ 5.5813e-01,  2.7226e-01, -4.2859e-01,  8.2400e-01, -1.3990e+00, -6.8156e-01,  8.5384e-01,  1.5678e+00, -6.6991e-01,  2.3984e-01],
         [ 2.1043e+00, -7.7001e-01, -1.5130e+00, -4.0357e-01, -4.4248e-01, -1.2654e+00, -1.3719e+00, -2.0433e-01, -1.1886e+00,  1.4066e-01],
         [ 6.4668e-01, -2.3070e-01,  3.9579e-01, -1.3584e-01,  4.0682e-02, -3.8097e-01, -1.6328e+00, -3.2575e-01,  2.1100e+00, -5.5824e-01],
         [ 3.8790e-01, -2.2768e+00,  2.2806e-01,  2.0612e-01, -1.0160e+00, -5.9985e-01,  1.7798e-01, -1.1433e+00,  1.3395e+00, -9.9675e-01],
         [ 2.5730e-01,  8.7788e-01,  7.3184e-01,  2.7381e-01,  1.7188e+00,  1.3450e+00, -1.2653e+00,  4.5117e-01,  1.8914e+00, -6.5245e-01],
         [-8.8793e-01, -1.0804e+00,  1.4245e+00, -1.1213e+00,  3.9184e-01, -4.9037e-01,  2.1468e+00, -2.0463e-01, -1.9494e-01,  1.6683e+00],
         [ 6.7413e-01,  1.1708e+00,  2.1614e-02, -9.1563e-01,  9.1419e-01,  1.2556e+00, -8.0774e-01,  2.0620e+00,  3.0488e-01, -1.4611e+00],
         [-2.0266e-01,  3.1468e-02,  7.3362e-02,  4.1918e-01, -8.1547e-01, -6.9506e-01,  8.9875e-01, -7.6348e-01, -1.9663e-01, -3.6331e-01],
         [-5.6020e-01, -8.6054e-01, -4.0041e-01,  1.6810e+00, -1.1213e-01, -5.4515e-01,  5.2534e-01,  6.9457e-01, -4.2326e-01,  1.6038e+00],
         [ 7.1524e-01,  1.9037e+00, -1.1198e+00, -2.2118e+00, -5.7546e-01,  4.3194e-01,  9.7220e-01,  3.1531e-01,  1.3362e+00,  5.8647e-01],
         [ 2.1032e-01, -6.5526e-02,  6.1104e-01,  6.6490e-01, -2.2863e+00,  5.8510e-01,  1.2774e+00,  8.8013e-01,  5.2002e-01, -1.0256e+00],
         [ 1.7627e+00, -2.8158e+00,  9.5682e-01, -6.8671e-01,  1.0243e+00,  1.7308e+00, -3.2469e-01,  3.1439e-01, -6.6913e-02, -6.5468e-01],
         [-8.2334e-01, -2.1418e+00,  7.7244e-01, -6.3585e-01,  2.5201e-01,  9.8329e-01,  2.7253e-01,  7.2023e-01, -1.2067e-01, -1.6670e+00],
         [-2.2227e+00, -1.0848e+00,  6.1240e-01, -5.7850e-01, -7.2574e-01,  1.8645e+00, -1.2680e+00,  1.3956e+00, -4.0160e-01, -4.7602e-01],
         [ 6.0241e-01, -1.3895e-01, -5.1991e-01, -4.2977e-01,  1.6126e+00, -3.2556e-01,  9.3039e-01, -2.8404e-01,  8.4639e-01,  1.8565e-02],
         [-1.6756e+00, -1.9437e+00,  1.1070e+00, -6.7445e-01, -1.8893e+00, -1.8424e+00,  1.3228e-01, -7.9287e-01,  1.2297e+00,  7.7734e-02],
         [-3.0807e-01, -3.3884e-01, -4.6697e-01, -4.0188e-01, -1.3110e+00,  3.0792e-02, -5.9219e-01, -1.1771e+00,  5.9547e-02, -2.9608e-01],
         [-3.4737e-01, -4.9671e-01, -1.3010e+00,  1.3099e+00, -2.6663e-01,  1.9698e-01,  5.0705e-01,  1.1396e+00,  1.9117e-01, -9.4624e-03],
         [ 3.5461e-01, -4.2383e-01,  1.0712e+00,  2.7125e+00, -1.1410e+00,  1.7503e+00, -1.1171e-01, -8.2202e-01,  7.9752e-01, -7.6852e-01],
         [ 1.5376e+00, -1.7771e+00,  5.1386e-01,  1.0508e+00,  1.3841e+00, -1.5027e+00, -1.0865e+00,  2.1496e+00, -9.2622e-01, -8.6180e-01],
         [-1.1079e+00,  9.7612e-01, -7.7305e-02, -2.1688e+00,  1.2137e+00, -1.8086e+00,  1.9426e-01,  6.6795e-01, -4.0847e-01, -7.1625e-01],
         [-1.0271e+00, -1.4785e+00,  4.5808e-02, -1.0694e-01,  3.5309e-01,  3.3017e-01, -1.1833e+00,  3.6330e-02,  2.4673e+00, -1.6547e-01],
         [-3.0691e-01,  1.4189e+00, -4.5662e-01, -1.5976e+00,  5.2934e-01, -6.3600e-01, -2.5095e-01,  7.0054e-01,  1.4388e+00, -1.0684e+00],
         [-1.6634e-01,  5.1761e-01,  2.7744e-01,  3.3585e-01, -7.6037e-01,  5.6602e-02, -1.5039e+00, -4.4853e-01,  5.2573e-01,  2.6190e-01],
         [ 2.0378e+00, -6.9654e-01,  8.4365e-01,  1.9249e+00, -3.4053e-01, -4.3293e-01,  1.3084e+00,  4.2931e-01,  1.6405e-02, -1.4018e+00],
         [ 5.6113e-01,  1.1513e+00,  6.9886e-01, -5.8976e-01, -1.6461e-01, -4.9310e-01,  1.7752e-01,  1.3772e-01,  2.7508e-01,  4.6830e-01],
         [-7.0300e-01, -1.7961e-01,  8.9739e-01,  5.1694e-02,  1.5087e+00,  4.0693e-01,  4.0822e-01, -4.9607e-01, -9.2910e-01, -1.9929e-01],
         [ 4.6825e-01,  1.0864e+00,  1.3477e+00, -8.6092e-02,  6.0735e-01,  2.2783e-01, -6.1864e-01,  1.1309e+00, -1.2079e-01,  1.6047e+00],
         [-1.0997e+00,  2.8125e-01,  8.7001e-02, -2.5707e-01,  2.2180e+00,  1.2402e+00, -6.5734e-01,  1.8484e+00, -2.6267e-01, -4.5390e-01],
         [ 1.4244e+00,  2.2692e+00,  1.3105e+00, -3.1789e-01, -3.7737e-01,  2.2604e+00,  1.2440e+00, -7.1942e-01,  1.2199e+00,  1.4356e+00],
         [-3.1398e-01,  8.9790e-01,  6.3589e-01, -8.4757e-01,  1.3522e-01, -3.9360e-01, -2.4841e-02, -3.6326e-01, -6.9412e-01, -9.8163e-01],
         [-5.5561e-02, -1.0469e+00,  1.4755e+00, -5.7177e-01, -1.5561e+00, -9.6327e-01, -4.3664e-01, -8.5481e-03,  4.4600e-02, -3.5374e-01],
         [ 1.4419e-01, -1.1567e+00,  1.8156e+00, -2.0921e+00, -6.5174e-01,  1.1426e+00, -7.5383e-01, -1.4663e+00, -3.4736e-02, -6.3170e-01],
         [-7.4101e-01,  1.8064e+00,  9.3781e-01, -3.8453e-01,  6.5850e-01,  7.6168e-01, -3.9328e-01, -3.6308e+00, -2.1864e+00,  2.6440e-01],
         [-5.5988e-01,  1.4537e+00, -2.9629e-01, -4.7022e-01, -1.1529e+00,  2.2968e+00,  1.6495e+00,  1.3179e+00,  7.5565e-01,  1.2472e+00],
         [ 7.8814e-01,  1.5493e+00,  9.9161e-01, -2.7026e+00, -6.1087e-01,  1.1898e+00, -4.8020e-01,  2.2536e+00,  1.1718e+00,  8.7930e-01],
         [-1.3813e+00, -7.8098e-02, -3.7233e-01,  3.6377e-01,  1.2563e+00, -1.2208e-01,  1.0121e-01,  4.7121e-01, -4.0038e-01,  5.0992e-01],
         [-7.8017e-01,  6.6291e-01,  6.5567e-01,  5.8466e-02,  7.8824e-01, -1.0858e+00, -2.2864e-01, -3.8932e-01,  1.4754e+00, -1.7087e-01],
         [-2.0884e+00,  7.9635e-01,  4.9622e-01,  6.0295e-01,  5.4060e-01,  1.0361e+00,  5.3184e-01, -3.1479e-01,  2.1018e-02, -5.4547e-02],
         [-8.1160e-01, -2.6107e-01, -6.4234e-01,  1.5523e+00, -2.3087e+00, -2.1958e+00,  3.2025e-01,  7.7272e-01, -1.6666e-01, -1.1849e-02],
         [ 1.2925e+00, -6.8382e-01, -1.2514e+00, -7.5954e-02,  3.7892e-01,  6.2014e-01, -8.9876e-02,  1.2097e+00,  1.0320e-02,  1.8313e+00],
         [-6.1592e-01, -6.0728e-01, -2.0597e+00,  1.5289e+00,  3.3787e-01,  1.9154e-01, -7.9394e-01,  6.7102e-01, -4.0961e-01, -5.3023e-01],
         [ 2.5329e-01, -1.9900e-01,  6.1014e-01, -1.4391e+00, -3.5117e-01,  3.5558e-01, -1.8120e+00,  4.6457e-01, -5.4801e-01, -1.0596e+00],
         [ 1.7401e-01,  3.8216e-01, -6.4097e-01, -1.5132e-01,  6.2558e-01, -6.2190e-01, -1.0873e+00, -1.3252e+00,  3.7723e-01, -5.8415e-02],
         [-2.8835e-01, -9.8602e-01,  1.4866e+00,  1.4713e-01, -1.3660e+00, -6.7085e-01,  9.5211e-01,  1.4749e+00, -1.5901e+00, -8.6603e-01],
         [ 1.2781e+00,  3.5260e-01, -7.5008e-02,  4.0587e-01,  5.3512e-01, -6.8784e-02,  1.2706e+00,  2.6958e-01, -3.1602e-02, -1.2757e+00],
         [-6.3726e-01, -7.6155e-01, -4.6703e-01, -1.2028e+00, -2.0164e-01, -4.8989e-01, -1.5937e+00,  9.4815e-01, -4.2648e-01, -1.4827e+00],
         [-4.5045e-01,  8.8896e-01,  1.2409e+00,  2.9480e-02, -5.1994e-01, -1.6538e-01, -2.7733e-01, -2.4466e-01, -1.9880e+00, -1.2664e+00],
         [ 3.8337e-01,  8.3983e-01, -4.6888e-01,  2.2659e-01,  3.4187e-01,  5.9337e-01,  1.9173e+00, -4.7866e-01, -3.4590e-01, -1.7239e+00],
         [-9.9090e-01,  1.9552e+00, -6.5327e-02,  1.4630e-01,  1.1357e+00, -2.6885e-01, -1.1784e+00,  6.8663e-01,  1.5644e+00,  1.0132e+00],
         [-1.1486e+00, -7.9156e-01, -3.2136e-01,  5.4563e-01, -6.9266e-01,  5.7798e-01, -2.1041e-02, -1.3801e-01,  9.9371e-02, -1.6284e-01],
         [ 1.8978e-01, -1.2572e+00, -1.2742e+00, -1.0626e+00, -6.3258e-01, -6.2932e-01, -1.6768e+00,  6.7240e-01,  1.9889e+00,  8.1569e-01],
         [-4.7595e-01,  1.6630e+00, -1.4545e+00, -2.3146e-01,  5.5500e-01,  3.2450e-01,  1.4937e+00,  5.8534e-01,  1.6673e+00, -1.0136e+00],
         [-1.3920e+00,  8.8565e-01,  9.1616e-01,  4.8508e-01, -1.0356e+00,  1.6210e-01,  1.0901e+00,  7.7187e-01,  1.6738e-02,  6.8036e-01],
         [-1.2983e-01,  9.7313e-02,  7.9569e-01, -2.1607e+00,  2.0470e+00, -2.0023e+00, -1.2304e+00,  8.7704e-01, -2.0921e+00,  1.5937e+00],
         [ 2.5637e+00, -1.2679e-01,  9.8450e-01,  7.9244e-01, -3.0765e-01,  6.7602e-01,  2.6806e+00, -8.7078e-01,  3.6106e-02,  1.0990e+00],
         [ 4.3041e-01,  5.3109e-01,  5.3204e-01, -1.5853e+00,  2.4220e+00,  4.7723e-01,  5.9568e-01,  2.7927e-01,  1.3260e-01,  4.7382e-01],
         [ 3.1056e-02, -1.4894e-01, -3.6520e-01, -1.8156e+00,  1.1129e+00,  1.1716e+00, -9.8115e-01,  1.0240e+00, -1.0366e+00, -1.9978e+00],
         [ 1.5088e+00,  1.9653e-01,  1.0685e+00,  4.8509e-01, -1.0362e+00,  1.0007e+00,  7.0487e-01, -6.9784e-01,  4.7286e-01, -6.5665e-01],
         [-8.6782e-01, -1.0432e-01, -5.5710e-01, -8.8292e-01, -7.0626e-01, -1.2800e+00,  1.3593e-01, -2.8107e-01,  1.7253e+00,  1.2699e-01],
         [ 2.0247e+00, -6.3806e-01,  5.3368e-01,  1.6807e-01, -1.0806e+00,  8.6527e-01,  9.8232e-01,  7.2404e-01,  4.3978e-01, -6.2775e-01],
         [-1.4592e-01, -4.2360e-01, -1.4882e+00,  8.5821e-01,  3.0351e+00, -1.1488e+00, -5.6119e-01,  3.0583e-02,  1.5137e-02,  1.1773e+00],
         [-9.6496e-01, -2.4675e-01, -6.7976e-01, -1.0098e+00,  1.3075e+00, -8.7691e-01, -1.5859e-02,  1.6088e+00, -4.2978e-01, -7.7904e-01],
         [ 1.1783e+00,  4.2371e-02, -1.7265e-01, -4.4424e-01,  2.9269e-01,  2.5777e-01, -2.1504e+00, -2.1542e+00, -4.2973e-01,  1.4808e+00]]])
        index_long = torch.tensor([[7, 9, 7, 2, 6, 3, 7, 2, 5, 8, 4, 0, 1, 3, 8, 4, 2, 2, 2, 7, 4, 3, 0, 5, 9, 7, 1, 9, 3, 2, 9, 2, 3, 5, 2, 7, 0, 6, 2, 4, 9, 5, 0, 5, 3, 4, 7, 0, 6, 9, 1, 9, 8, 8, 9, 3, 9, 3, 8, 1, 6, 6, 1, 9,
         9, 6, 3, 7, 2, 9, 2, 1, 6, 5, 1, 2, 0, 7, 0, 4, 6, 0, 3, 7, 0, 8, 6, 6, 5, 9, 2, 6, 6, 1, 2, 9, 6, 3, 0, 1]])
        weights_long = torch.tensor([1.0, 1.5, 2.0])
        mask_long = torch.tensor([[False,  True, False, False, False,  True, False, False, False,  True, False, False, False, False,  True, False,  True,  True,  True, False,  True, False,  True,  True,  True,  True,  True,
          True,  True,  True, False, False,  True,  True,  True, False,  True, False, False, False, False, False,  True,  True,  True,  True,  True, False,  True,  True, False,  True, False,  True,
         False,  True,  True, False, False, False, False, False, False, False, False,  True,  True, False,  True,  True,  True,  True, False,  True, False,  True,  True,  True, False,  True, False,
          True, False,  True, False, False,  True, False,  True,  True,  True,  True,  True,  True,  True,  True,  True,  True,  True, False]])
        
        # print(logits_long)
        # print(index_long)
        # print(mask_long)
        result_long = selective_log_softmax(logits_long, index_long, weights_long, mask_long)
        # print(result_long)
        expected_result_long = torch.tensor([[-4.2982, -2.0994, -3.5248, -2.1130, -6.0739, -3.6199, -2.5437, -3.9758, -3.9772, -1.4643, -4.3679, -5.2518, -5.5183, -3.2097, -3.1966, -2.1003, -4.5670, -2.5401, -1.8315, -4.3537, -3.0137,
         -4.0716, -2.7144, -2.5828, -2.3792, -2.7208, -2.7476, -3.7522, -3.3420, -2.8925, -3.1595, -5.2142, -3.1541, -4.1067, -4.2535, -2.0050, -3.4145, -5.3306, -4.1178, -5.3420, -4.2565, -5.4061,
         -3.0287, -3.7974, -3.5515, -2.8446, -3.8196, -2.2359, -4.3279, -4.1927, -4.7869, -3.3988, -3.2924, -2.9329, -5.6977, -3.6731, -3.2465, -4.3514, -1.9075, -3.1540, -3.3521, -4.5725, -4.4737,
         -2.6921, -5.3269, -3.2806, -5.6062, -3.5496, -2.5653, -4.7409, -4.2636, -5.7637, -3.5728, -4.0220, -3.0781, -3.6145, -3.6710, -3.4481, -2.6341, -2.1152, -2.6671, -4.0120, -4.2150, -4.4676,
         -3.3955, -3.3039, -3.5099, -6.1195, -2.3525, -3.4645, -2.8708, -3.0044, -2.5637, -3.7749, -2.8203, -3.3251, -3.1853, -3.7016, -2.0009, -3.9528]])
        torch.testing.assert_close(result_long, expected_result_long, atol=1e-4, rtol=1e-4)
        self.assertEqual(result_long.shape, (1, long_seq_len))
        self.assertTrue(torch.isfinite(result_long).all())



if __name__ == "__main__":
    unittest.main()
